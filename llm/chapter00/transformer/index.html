
<!doctype html>
<html lang="zh" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../attention/">
      
      
        <link rel="next" href="../bert/">
      
      
      <link rel="icon" href="../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.14">
    
    
      
        <title>Transformeræ¶æ„ - ğŸ“šé¢è¯•ç§˜ç±</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.342714a4.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../styles/css/extra.css">
    
      <link rel="stylesheet" href="../../../styles/css/custom-toc.css">
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="teal" data-md-color-accent="amber">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#transformer" class="md-skip">
          è·³è½¬è‡³
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="é¡µçœ‰">
    <a href="../../.." title="ğŸ“šé¢è¯•ç§˜ç±" class="md-header__button md-logo" aria-label="ğŸ“šé¢è¯•ç§˜ç±" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            ğŸ“šé¢è¯•ç§˜ç±
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Transformeræ¶æ„
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="default" data-md-color-primary="teal" data-md-color-accent="amber"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2a7 7 0 0 0-7 7c0 2.38 1.19 4.47 3 5.74V17a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1v-2.26c1.81-1.27 3-3.36 3-5.74a7 7 0 0 0-7-7M9 21a1 1 0 0 0 1 1h4a1 1 0 0 0 1-1v-1H9z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="slate" data-md-color-primary="teal" data-md-color-accent="amber"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2a7 7 0 0 1 7 7c0 2.38-1.19 4.47-3 5.74V17a1 1 0 0 1-1 1H9a1 1 0 0 1-1-1v-2.26C6.19 13.47 5 11.38 5 9a7 7 0 0 1 7-7M9 21v-1h6v1a1 1 0 0 1-1 1h-4a1 1 0 0 1-1-1m3-17a5 5 0 0 0-5 5c0 2.05 1.23 3.81 3 4.58V16h4v-2.42c1.77-.77 3-2.53 3-4.58a5 5 0 0 0-5-5"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="æœç´¢" placeholder="æœç´¢" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="æŸ¥æ‰¾">
        
        <button type="reset" class="md-search__icon md-icon" title="æ¸…ç©ºå½“å‰å†…å®¹" aria-label="æ¸…ç©ºå½“å‰å†…å®¹" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            æ­£åœ¨åˆå§‹åŒ–æœç´¢å¼•æ“
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
  </nav>
  
    
      
<nav class="md-tabs" aria-label="æ ‡ç­¾" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../.." class="md-tabs__link">
        
  
  
    
  
  ğŸ Home

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../../maths/math/" class="md-tabs__link">
        
  
  
    
  
  ğŸµç¨‹åºå‘˜çš„æ•°å­¦

      </a>
    </li>
  

      
        
  
  
  
  
    
    
      
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../langs/python/basic/" class="md-tabs__link">
          
  
  
    
  
  ğŸ¦è¯­è¨€å¤§æœ¬è¥

        </a>
      </li>
    
  

    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../algorithm/basic/" class="md-tabs__link">
          
  
  
    
  
  ğŸ¹ç®—æ³•å¤§æœ¬è¥

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../cloud/docker/docker/" class="md-tabs__link">
          
  
  
    
  
  ğŸºäº‘åŸç”Ÿ

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../analysis/numpy/" class="md-tabs__link">
          
  
  
    
  
  ğŸ¦§æ•°æ®åˆ†æå¤§è¥

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../machinelearning/scikit-learn/basic/" class="md-tabs__link">
          
  
  
    
  
  ğŸ´æœºå™¨å­¦ä¹ 

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../deeplearning/pytorch/tensor/" class="md-tabs__link">
          
  
  
    
  
  ğŸ£æ·±åº¦å­¦ä¹ 

        </a>
      </li>
    
  

    
  

      
        
  
  
  
    
  
  
    
    
      
  
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../../huggingface/pipeline/" class="md-tabs__link">
          
  
  
    
  
  ğŸ™å¤§æ¨¡å‹

        </a>
      </li>
    
  

    
  

      
        
  
  
  
  
    
    
      
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../llmapp/langchain/basic/" class="md-tabs__link">
          
  
  
    
  
  ğŸ å¤§æ¨¡å‹åº”ç”¨

        </a>
      </li>
    
  

    
  

      
    </ul>
  </div>
</nav>
    
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="å¯¼èˆªæ " data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="ğŸ“šé¢è¯•ç§˜ç±" class="md-nav__button md-logo" aria-label="ğŸ“šé¢è¯•ç§˜ç±" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    ğŸ“šé¢è¯•ç§˜ç±
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ğŸ Home
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../maths/math/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ğŸµç¨‹åºå‘˜çš„æ•°å­¦
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
    
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
  
    
  
  
  
    <a href="../../../langs/python/basic/" class="md-nav__link">
      
  
  
  <span class="md-ellipsis">
    ğŸ¦è¯­è¨€å¤§æœ¬è¥
    
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

  

      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
    
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
  
    <a href="../../../algorithm/basic/" class="md-nav__link">
      
  
  
  <span class="md-ellipsis">
    ğŸ¹ç®—æ³•å¤§æœ¬è¥
    
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
    
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
  
    <a href="../../../cloud/docker/docker/" class="md-nav__link">
      
  
  
  <span class="md-ellipsis">
    ğŸºäº‘åŸç”Ÿ
    
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
  
    <a href="../../../analysis/numpy/" class="md-nav__link">
      
  
  
  <span class="md-ellipsis">
    ğŸ¦§æ•°æ®åˆ†æå¤§è¥
    
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
    
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
  
    <a href="../../../machinelearning/scikit-learn/basic/" class="md-nav__link">
      
  
  
  <span class="md-ellipsis">
    ğŸ´æœºå™¨å­¦ä¹ 
    
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
    
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
  
    
  
  
  
    <a href="../../../deeplearning/pytorch/tensor/" class="md-nav__link">
      
  
  
  <span class="md-ellipsis">
    ğŸ£æ·±åº¦å­¦ä¹ 
    
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

  

      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
      
        
      
        
      
        
      
    
    
    
      
        
        
      
      
    
    
      
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_9" checked>
        
          
          <label class="md-nav__link" for="__nav_9" id="__nav_9_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    ğŸ™å¤§æ¨¡å‹
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_9_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_9">
            <span class="md-nav__icon md-icon"></span>
            ğŸ™å¤§æ¨¡å‹
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
  
    <a href="../../huggingface/pipeline/" class="md-nav__link">
      
  
  
  <span class="md-ellipsis">
    Hugging Face Transformers
    
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
      
        
      
        
      
        
      
    
    
    
      
      
    
    
      
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_9_2" checked>
        
          
          <label class="md-nav__link" for="__nav_9_2" id="__nav_9_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    ç¬¬0ç« ï¼šå¤§æ¨¡å‹åŸºç¡€
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_9_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_9_2">
            <span class="md-nav__icon md-icon"></span>
            ç¬¬0ç« ï¼šå¤§æ¨¡å‹åŸºç¡€
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../attention/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    æ³¨æ„åŠ›æœºåˆ¶
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    Transformeræ¶æ„
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    Transformeræ¶æ„
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="ç›®å½•">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      ç›®å½•
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    <span class="md-ellipsis">
      å‚è€ƒæ–‡ç« 
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#transformer_1" class="md-nav__link">
    <span class="md-ellipsis">
      Transformer å®ç°ä»£ç 
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Transformer å®ç°ä»£ç ">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    <span class="md-ellipsis">
      ä¸€ã€æ¨¡å‹è¾“å…¥
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#encoder" class="md-nav__link">
    <span class="md-ellipsis">
      äºŒã€Encoder
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#decoder" class="md-nav__link">
    <span class="md-ellipsis">
      ä¸‰ã€Decoder
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    <span class="md-ellipsis">
      å››ã€æ¨¡å‹è¾“å‡º
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    <span class="md-ellipsis">
      äº”ã€æ¨¡å‹æ„å»º
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../bert/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Bertæ¶æ„
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
    
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
  
    <a href="../../chapter01/optimizer/" class="md-nav__link">
      
  
  
  <span class="md-ellipsis">
    ç¬¬ä¸€ç« ï¼šé¢„è®­ç»ƒ
    
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
    
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
  
    
  
  
  
    <a href="../../../llmapp/langchain/basic/" class="md-nav__link">
      
  
  
  <span class="md-ellipsis">
    ğŸ å¤§æ¨¡å‹åº”ç”¨
    
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

  

      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="ç›®å½•">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      ç›®å½•
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    <span class="md-ellipsis">
      å‚è€ƒæ–‡ç« 
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#transformer_1" class="md-nav__link">
    <span class="md-ellipsis">
      Transformer å®ç°ä»£ç 
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Transformer å®ç°ä»£ç ">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    <span class="md-ellipsis">
      ä¸€ã€æ¨¡å‹è¾“å…¥
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#encoder" class="md-nav__link">
    <span class="md-ellipsis">
      äºŒã€Encoder
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#decoder" class="md-nav__link">
    <span class="md-ellipsis">
      ä¸‰ã€Decoder
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    <span class="md-ellipsis">
      å››ã€æ¨¡å‹è¾“å‡º
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    <span class="md-ellipsis">
      äº”ã€æ¨¡å‹æ„å»º
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  



<h1 id="transformer">Transformeræ¨¡å‹æ¶æ„<a class="headerlink" href="#transformer" title="Permanent link">&para;</a></h1>
<h2 id="_1">å‚è€ƒæ–‡ç« <a class="headerlink" href="#_1" title="Permanent link">&para;</a></h2>
<p><a href="https://ifwind.github.io/2021/08/31/Transformer-BERT-%E5%AE%9E%E6%88%98/">Transformeræ¶æ„åŸºç¡€æ¦‚å¿µ</a></p>
<h2 id="transformer_1">Transformer å®ç°ä»£ç <a class="headerlink" href="#transformer_1" title="Permanent link">&para;</a></h2>
<h3 id="_2">ä¸€ã€æ¨¡å‹è¾“å…¥<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h3>
<h4 id="11-embedding">1.1  Embeddingï¼ˆè¯åµŒå…¥ï¼‰<a class="headerlink" href="#11-embedding" title="Permanent link">&para;</a></h4>
<p>Embeddingå±‚çš„ä½œç”¨æ˜¯å°†æŸç§æ ¼å¼çš„è¾“å…¥æ•°æ®ï¼Œä¾‹å¦‚æ–‡æœ¬ï¼Œè½¬å˜ä¸ºæ¨¡å‹å¯ä»¥å¤„ç†çš„å‘é‡è¡¨ç¤ºï¼Œæ¥æè¿°åŸå§‹æ•°æ®æ‰€åŒ…å«çš„ä¿¡æ¯ã€‚</p>
<p>Embeddingå±‚è¾“å‡ºçš„å¯ä»¥ç†è§£ä¸ºå½“å‰æ—¶é—´æ­¥çš„ç‰¹å¾ï¼Œå¦‚æœæ˜¯æ–‡æœ¬ä»»åŠ¡ï¼Œè¿™é‡Œå°±å¯ä»¥æ˜¯Word Embeddingï¼Œå¦‚æœæ˜¯å…¶ä»–ä»»åŠ¡ï¼Œå°±å¯ä»¥æ˜¯ä»»ä½•åˆç†æ–¹æ³•æ‰€æå–çš„ç‰¹å¾ã€‚</p>
<p>æ„å»ºEmbeddingå±‚çš„ä»£ç å¾ˆç®€å•ï¼Œæ ¸å¿ƒæ˜¯å€ŸåŠ©torchæä¾›çš„nn.Embeddingï¼Œå¦‚ä¸‹ï¼š</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">torch.nn</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">nn</span>
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="k">class</span><span class="w"> </span><span class="nc">Embeddings</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vocab_size</span><span class="p">,</span> <span class="n">embed_size</span><span class="p">):</span>
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a><span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
</span><span id="__span-0-7"><a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a><span class="sd">        åµŒå…¥å±‚</span>
</span><span id="__span-0-8"><a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a><span class="sd">        :param vocab_size:  æŒ‡è¯è¡¨çš„å¤§å°</span>
</span><span id="__span-0-9"><a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a><span class="sd">        :param embed_size: æŒ‡è¯åµŒå…¥çš„ç»´åº¦</span>
</span><span id="__span-0-10"><a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a><span class="sd">        &#39;&#39;&#39;</span>
</span><span id="__span-0-11"><a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>        <span class="nb">super</span><span class="p">(</span><span class="n">Embeddings</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="__span-0-12"><a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>        <span class="c1"># åµŒå…¥</span>
</span><span id="__span-0-13"><a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">embedding</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Embedding</span><span class="p">(</span><span class="n">num_embeddings</span><span class="o">=</span><span class="n">vocab_size</span><span class="p">,</span> <span class="n">embedding_dim</span><span class="o">=</span><span class="n">embed_size</span><span class="p">)</span>
</span><span id="__span-0-14"><a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>
</span><span id="__span-0-15"><a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
</span><span id="__span-0-16"><a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a><span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
</span><span id="__span-0-17"><a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a><span class="sd">        :param x: è¿™é‡Œä»£è¡¨è¾“å…¥ç»™æ¨¡å‹çš„å•è¯æ–‡æœ¬é€šè¿‡è¯è¡¨æ˜ å°„åçš„one-hotå‘é‡</span>
</span><span id="__span-0-18"><a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a><span class="sd">        :return:</span>
</span><span id="__span-0-19"><a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a><span class="sd">        &#39;&#39;&#39;</span>
</span><span id="__span-0-20"><a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">embedding</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</span></code></pre></div>
<div class="admonition info">
<p class="admonition-title">Info</p>
<ul>
<li><strong>num_embeddings</strong>: è¯æ±‡è¡¨çš„å¤§å°ï¼ˆå³è¯çš„ç§ç±»æ•°ï¼‰</li>
<li><strong>embedding_dim</strong>: æ¯ä¸ªè¯è¢«æ˜ å°„æˆçš„å‘é‡ç»´åº¦ï¼ˆå³åµŒå…¥ç»´åº¦ï¼‰</li>
</ul>
</div>
<h4 id="12">1.2 ä½ç½®ç¼–ç <a class="headerlink" href="#12" title="Permanent link">&para;</a></h4>
<p>ä½ç½®ç¼–ç ç”¨ä»¥è¡¨è¾¾å…ƒç´ åœ¨åºåˆ—ä¸­çš„ä½ç½®ç‰¹å¾ï¼Œæ¯”å¦‚åè¯ç»å¸¸å‡ºç°åœ¨å¥å­å¼€å¤´ã€‚</p>
<p>ä½ç½®ç¼–ç ç›´æ¥ä¸å…ƒç´ çš„embeddingç›¸åŠ ã€‚</p>
<p>ä»£ç ä¸­éœ€è¦æ³¨æ„ï¼šX_åªæ˜¯åˆå§‹åŒ–çš„çŸ©é˜µï¼›å®Œæˆä½ç½®ç¼–ç ä¹‹åä¼šåŠ ä¸€ä¸ªdropoutã€‚å¦å¤–ï¼Œä½ç½®ç¼–ç æ˜¯æœ€ååŠ ä¸Šå»çš„ï¼Œå› æ­¤è¾“å…¥è¾“å‡ºå½¢çŠ¶ä¸å˜ã€‚</p>
<p><strong>æ•°å­¦å…¬å¼</strong></p>
<p>å¯¹äºä½ç½® <span class="arithmatex">\(pos\)</span> å’Œç»´åº¦ <span class="arithmatex">\(i\)</span>ï¼š</p>
<div class="arithmatex">\[
PE_{(pos, 2i)} = \sin\left(\frac{pos}{10000^{2i/d_{model}}}\right)
\]</div>
<div class="arithmatex">\[
PE_{(pos, 2i+1)} = \cos\left(\frac{pos}{10000^{2i/d_{model}}}\right)
\]</div>
<p>å…¶ä¸­ï¼š</p>
<ul>
<li><span class="arithmatex">\(pos\)</span> æ˜¯è¯åœ¨å¥å­ä¸­çš„ä½ç½®ï¼ˆä» 0 å¼€å§‹ï¼‰</li>
<li><span class="arithmatex">\(i\)</span> æ˜¯ä½ç½®å‘é‡çš„ç»´åº¦ç´¢å¼•</li>
<li><span class="arithmatex">\(d_{model}\)</span> æ˜¯åµŒå…¥å‘é‡çš„ç»´åº¦</li>
</ul>
<div class="language-python highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">math</span>
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">torch.nn</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">nn</span>
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a>
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a><span class="k">class</span><span class="w"> </span><span class="nc">PositionalEncoding</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
</span><span id="__span-1-6"><a id="__codelineno-1-6" name="__codelineno-1-6" href="#__codelineno-1-6"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">d_model</span><span class="p">,</span> <span class="n">dropout</span><span class="p">,</span> <span class="n">max_len</span><span class="o">=</span><span class="mi">5000</span><span class="p">):</span>
</span><span id="__span-1-7"><a id="__codelineno-1-7" name="__codelineno-1-7" href="#__codelineno-1-7"></a><span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
</span><span id="__span-1-8"><a id="__codelineno-1-8" name="__codelineno-1-8" href="#__codelineno-1-8"></a><span class="sd">        ä½ç½®ç¼–ç </span>
</span><span id="__span-1-9"><a id="__codelineno-1-9" name="__codelineno-1-9" href="#__codelineno-1-9"></a><span class="sd">        :param d_model: è¯åµŒå…¥ç»´åº¦</span>
</span><span id="__span-1-10"><a id="__codelineno-1-10" name="__codelineno-1-10" href="#__codelineno-1-10"></a><span class="sd">        :param dropout: dropoutè§¦å‘æ¯”ç‡</span>
</span><span id="__span-1-11"><a id="__codelineno-1-11" name="__codelineno-1-11" href="#__codelineno-1-11"></a><span class="sd">        :param max_len: æ¯ä¸ªå¥å­çš„æœ€å¤§é•¿åº¦</span>
</span><span id="__span-1-12"><a id="__codelineno-1-12" name="__codelineno-1-12" href="#__codelineno-1-12"></a><span class="sd">        &#39;&#39;&#39;</span>
</span><span id="__span-1-13"><a id="__codelineno-1-13" name="__codelineno-1-13" href="#__codelineno-1-13"></a>        <span class="nb">super</span><span class="p">(</span><span class="n">PositionalEncoding</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="__span-1-14"><a id="__codelineno-1-14" name="__codelineno-1-14" href="#__codelineno-1-14"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dropout</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="n">p</span><span class="o">=</span><span class="n">dropout</span><span class="p">)</span>
</span><span id="__span-1-15"><a id="__codelineno-1-15" name="__codelineno-1-15" href="#__codelineno-1-15"></a>
</span><span id="__span-1-16"><a id="__codelineno-1-16" name="__codelineno-1-16" href="#__codelineno-1-16"></a>        <span class="n">pe</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">max_len</span><span class="p">,</span> <span class="n">d_model</span><span class="p">)</span> <span class="c1">#  å•è¯ä½ç½®çŸ©é˜µï¼ˆåˆå§‹å€¼ï¼‰</span>
</span><span id="__span-1-17"><a id="__codelineno-1-17" name="__codelineno-1-17" href="#__codelineno-1-17"></a>        <span class="n">position</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">max_len</span><span class="p">)</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># å•è¯å¯¹åº”çš„ä½ç½®</span>
</span><span id="__span-1-18"><a id="__codelineno-1-18" name="__codelineno-1-18" href="#__codelineno-1-18"></a>
</span><span id="__span-1-19"><a id="__codelineno-1-19" name="__codelineno-1-19" href="#__codelineno-1-19"></a>        <span class="n">div_term</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">d_model</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span>
</span><span id="__span-1-20"><a id="__codelineno-1-20" name="__codelineno-1-20" href="#__codelineno-1-20"></a>                             <span class="o">-</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">10000.0</span><span class="p">)</span> <span class="o">/</span> <span class="n">d_model</span><span class="p">))</span>
</span><span id="__span-1-21"><a id="__codelineno-1-21" name="__codelineno-1-21" href="#__codelineno-1-21"></a>        <span class="n">pe</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">position</span> <span class="o">*</span> <span class="n">div_term</span><span class="p">)</span>
</span><span id="__span-1-22"><a id="__codelineno-1-22" name="__codelineno-1-22" href="#__codelineno-1-22"></a>        <span class="n">pe</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">position</span> <span class="o">*</span> <span class="n">div_term</span><span class="p">)</span>
</span><span id="__span-1-23"><a id="__codelineno-1-23" name="__codelineno-1-23" href="#__codelineno-1-23"></a>        <span class="n">pe</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="__span-1-24"><a id="__codelineno-1-24" name="__codelineno-1-24" href="#__codelineno-1-24"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">register_buffer</span><span class="p">(</span><span class="s1">&#39;pe&#39;</span><span class="p">,</span> <span class="n">pe</span><span class="p">)</span>
</span><span id="__span-1-25"><a id="__codelineno-1-25" name="__codelineno-1-25" href="#__codelineno-1-25"></a>
</span><span id="__span-1-26"><a id="__codelineno-1-26" name="__codelineno-1-26" href="#__codelineno-1-26"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
</span><span id="__span-1-27"><a id="__codelineno-1-27" name="__codelineno-1-27" href="#__codelineno-1-27"></a>        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">pe</span><span class="p">[:,</span> <span class="p">:</span><span class="n">x</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">1</span><span class="p">)]</span>
</span><span id="__span-1-28"><a id="__codelineno-1-28" name="__codelineno-1-28" href="#__codelineno-1-28"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dropout</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</span></code></pre></div>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p>register_buffer æ˜¯ PyTorch ä¸­ nn.Module çš„ä¸€ä¸ªæ–¹æ³•ï¼Œç”¨æ¥ æ³¨å†Œä¸€ä¸ªä¸æ˜¯å‚æ•°ï¼ˆä¸å‚ä¸æ¢¯åº¦æ›´æ–°ï¼‰ä½†åœ¨æ¨¡å‹ä¿å­˜å’Œç§»åŠ¨ï¼ˆå¦‚ .cuda()ã€.to()ï¼‰æ—¶è·Ÿéšçš„å¼ é‡ã€‚</p>
</div>
<h3 id="encoder">äºŒã€Encoder<a class="headerlink" href="#encoder" title="Permanent link">&para;</a></h3>
<h4 id="21">2.1 ç¼–ç å™¨<a class="headerlink" href="#21" title="Permanent link">&para;</a></h4>
<p>ç¼–ç å™¨ä½œç”¨æ˜¯ç”¨äºå¯¹è¾“å…¥è¿›è¡Œç‰¹å¾æå–ï¼Œä¸ºè§£ç ç¯èŠ‚æä¾›æœ‰æ•ˆçš„è¯­ä¹‰ä¿¡æ¯</p>
<p>æ•´ä½“æ¥çœ‹ç¼–ç å™¨ç”±Nä¸ªç¼–ç å™¨å±‚ç®€å•å †å è€Œæˆï¼Œå› æ­¤å®ç°éå¸¸ç®€å•ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="c1"># å®šä¹‰ä¸€ä¸ªcloneså‡½æ•°ï¼Œæ¥æ›´æ–¹ä¾¿çš„å°†æŸä¸ªç»“æ„å¤åˆ¶è‹¥å¹²ä»½</span>
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">clones</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a>    <span class="s2">&quot;Produce N identical layers.&quot;</span>
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a>    <span class="k">return</span> <span class="n">nn</span><span class="o">.</span><span class="n">ModuleList</span><span class="p">([</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">module</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">)])</span>
</span><span id="__span-2-5"><a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a>
</span><span id="__span-2-6"><a id="__codelineno-2-6" name="__codelineno-2-6" href="#__codelineno-2-6"></a>
</span><span id="__span-2-7"><a id="__codelineno-2-7" name="__codelineno-2-7" href="#__codelineno-2-7"></a><span class="k">class</span><span class="w"> </span><span class="nc">Encoder</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
</span><span id="__span-2-8"><a id="__codelineno-2-8" name="__codelineno-2-8" href="#__codelineno-2-8"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="__span-2-9"><a id="__codelineno-2-9" name="__codelineno-2-9" href="#__codelineno-2-9"></a><span class="sd">    Encoder</span>
</span><span id="__span-2-10"><a id="__codelineno-2-10" name="__codelineno-2-10" href="#__codelineno-2-10"></a><span class="sd">    The encoder is composed of a stack of N=6 identical layers.</span>
</span><span id="__span-2-11"><a id="__codelineno-2-11" name="__codelineno-2-11" href="#__codelineno-2-11"></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="__span-2-12"><a id="__codelineno-2-12" name="__codelineno-2-12" href="#__codelineno-2-12"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">layer</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
</span><span id="__span-2-13"><a id="__codelineno-2-13" name="__codelineno-2-13" href="#__codelineno-2-13"></a>        <span class="nb">super</span><span class="p">(</span><span class="n">Encoder</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="__span-2-14"><a id="__codelineno-2-14" name="__codelineno-2-14" href="#__codelineno-2-14"></a>        <span class="c1"># è°ƒç”¨æ—¶ä¼šå°†ç¼–ç å™¨å±‚ä¼ è¿›æ¥ï¼Œæˆ‘ä»¬ç®€å•å…‹éš†Nåˆ†ï¼Œå åŠ åœ¨ä¸€èµ·ï¼Œç»„æˆå®Œæ•´çš„Encoder</span>
</span><span id="__span-2-15"><a id="__codelineno-2-15" name="__codelineno-2-15" href="#__codelineno-2-15"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">layers</span> <span class="o">=</span> <span class="n">clones</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span>
</span><span id="__span-2-16"><a id="__codelineno-2-16" name="__codelineno-2-16" href="#__codelineno-2-16"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">norm</span> <span class="o">=</span> <span class="n">LayerNorm</span><span class="p">(</span><span class="n">layer</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
</span><span id="__span-2-17"><a id="__codelineno-2-17" name="__codelineno-2-17" href="#__codelineno-2-17"></a>
</span><span id="__span-2-18"><a id="__codelineno-2-18" name="__codelineno-2-18" href="#__codelineno-2-18"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">mask</span><span class="p">):</span>
</span><span id="__span-2-19"><a id="__codelineno-2-19" name="__codelineno-2-19" href="#__codelineno-2-19"></a>        <span class="s2">&quot;Pass the input (and mask) through each layer in turn.&quot;</span>
</span><span id="__span-2-20"><a id="__codelineno-2-20" name="__codelineno-2-20" href="#__codelineno-2-20"></a>        <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="p">:</span>
</span><span id="__span-2-21"><a id="__codelineno-2-21" name="__codelineno-2-21" href="#__codelineno-2-21"></a>            <span class="n">x</span> <span class="o">=</span> <span class="n">layer</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">mask</span><span class="p">)</span>
</span><span id="__span-2-22"><a id="__codelineno-2-22" name="__codelineno-2-22" href="#__codelineno-2-22"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</span></code></pre></div>
<p>ä¸Šé¢çš„ä»£ç ä¸­æœ‰ä¸€ä¸ªå°ç»†èŠ‚ï¼Œå°±æ˜¯ç¼–ç å™¨çš„è¾“å…¥é™¤äº†xï¼Œä¹Ÿå°±æ˜¯embeddingä»¥å¤–ï¼Œè¿˜æœ‰ä¸€ä¸ªmaskï¼Œä¸ºäº†ä»‹ç»è¿ç»­æ€§ï¼Œè¿™é‡Œå…ˆå¿½ç•¥ï¼Œåé¢ä¼šè®²è§£ã€‚</p>
<p>ä¸‹é¢æˆ‘ä»¬æ¥çœ‹çœ‹å•ä¸ªçš„ç¼–ç å™¨å±‚éƒ½åŒ…å«ä»€ä¹ˆï¼Œå¦‚ä½•å®ç°ã€‚</p>
<h4 id="22">2.2 ç¼–ç å™¨å±‚<a class="headerlink" href="#22" title="Permanent link">&para;</a></h4>
<p>æ¯ä¸ªç¼–ç å™¨å±‚ç”±ä¸¤ä¸ªå­å±‚è¿æ¥ç»“æ„ç»„æˆï¼š</p>
<p>ç¬¬ä¸€ä¸ªå­å±‚åŒ…æ‹¬ä¸€ä¸ªå¤šå¤´è‡ªæ³¨æ„åŠ›å±‚å’Œè§„èŒƒåŒ–å±‚ä»¥åŠä¸€ä¸ªæ®‹å·®è¿æ¥ï¼›</p>
<p>ç¬¬äºŒä¸ªå­å±‚åŒ…æ‹¬ä¸€ä¸ªå‰é¦ˆå…¨è¿æ¥å±‚å’Œè§„èŒƒåŒ–å±‚ä»¥åŠä¸€ä¸ªæ®‹å·®è¿æ¥ï¼›</p>
<p>å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><img alt="layers.jpg" src="../../../imgs/llm/chapter00/layers.jpg" /></p>
<p>æˆ‘ä»¬å…ˆå®šä¹‰ä¸€ä¸ªSubLayerConnectionç±»æ¥æè¿°è¿™ç§ç»“æ„å…³ç³»</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">SublayerConnection</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot; </span>
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a><span class="sd">    å®ç°å­å±‚è¿æ¥ç»“æ„çš„ç±»</span>
</span><span id="__span-3-4"><a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="__span-3-5"><a id="__codelineno-3-5" name="__codelineno-3-5" href="#__codelineno-3-5"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">dropout</span><span class="p">):</span>
</span><span id="__span-3-6"><a id="__codelineno-3-6" name="__codelineno-3-6" href="#__codelineno-3-6"></a>        <span class="nb">super</span><span class="p">(</span><span class="n">SublayerConnection</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="__span-3-7"><a id="__codelineno-3-7" name="__codelineno-3-7" href="#__codelineno-3-7"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">norm</span> <span class="o">=</span> <span class="n">LayerNorm</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>
</span><span id="__span-3-8"><a id="__codelineno-3-8" name="__codelineno-3-8" href="#__codelineno-3-8"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dropout</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="n">dropout</span><span class="p">)</span>
</span><span id="__span-3-9"><a id="__codelineno-3-9" name="__codelineno-3-9" href="#__codelineno-3-9"></a>
</span><span id="__span-3-10"><a id="__codelineno-3-10" name="__codelineno-3-10" href="#__codelineno-3-10"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">sublayer</span><span class="p">):</span>
</span><span id="__span-3-11"><a id="__codelineno-3-11" name="__codelineno-3-11" href="#__codelineno-3-11"></a>
</span><span id="__span-3-12"><a id="__codelineno-3-12" name="__codelineno-3-12" href="#__codelineno-3-12"></a>        <span class="c1"># åŸpaperçš„æ–¹æ¡ˆ</span>
</span><span id="__span-3-13"><a id="__codelineno-3-13" name="__codelineno-3-13" href="#__codelineno-3-13"></a>        <span class="c1">#sublayer_out = sublayer(x)</span>
</span><span id="__span-3-14"><a id="__codelineno-3-14" name="__codelineno-3-14" href="#__codelineno-3-14"></a>        <span class="c1">#x_norm = self.norm(x + self.dropout(sublayer_out))</span>
</span><span id="__span-3-15"><a id="__codelineno-3-15" name="__codelineno-3-15" href="#__codelineno-3-15"></a>
</span><span id="__span-3-16"><a id="__codelineno-3-16" name="__codelineno-3-16" href="#__codelineno-3-16"></a>        <span class="c1"># ç¨åŠ è°ƒæ•´çš„ç‰ˆæœ¬</span>
</span><span id="__span-3-17"><a id="__codelineno-3-17" name="__codelineno-3-17" href="#__codelineno-3-17"></a>        <span class="n">sublayer_out</span> <span class="o">=</span> <span class="n">sublayer</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</span><span id="__span-3-18"><a id="__codelineno-3-18" name="__codelineno-3-18" href="#__codelineno-3-18"></a>        <span class="n">sublayer_out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dropout</span><span class="p">(</span><span class="n">sublayer_out</span><span class="p">)</span>
</span><span id="__span-3-19"><a id="__codelineno-3-19" name="__codelineno-3-19" href="#__codelineno-3-19"></a>        <span class="n">x_norm</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">sublayer_out</span><span class="p">)</span>
</span><span id="__span-3-20"><a id="__codelineno-3-20" name="__codelineno-3-20" href="#__codelineno-3-20"></a>        <span class="k">return</span> <span class="n">x_norm</span>
</span></code></pre></div>
<p>æ³¨ï¼šä¸Šé¢çš„å®ç°ä¸­ï¼Œæˆ‘å¯¹æ®‹å·®çš„é“¾æ¥æ–¹æ¡ˆè¿›è¡Œäº†å°å°çš„è°ƒæ•´ï¼Œå’ŒåŸè®ºæ–‡æœ‰æ‰€ä¸åŒã€‚æŠŠxä»normä¸­æ‹¿å‡ºæ¥ï¼Œä¿è¯æ°¸è¿œæœ‰ä¸€æ¡â€œé«˜é€Ÿå…¬è·¯â€ï¼Œè¿™æ ·ç†è®ºä¸Šä¼šæ”¶æ•›çš„å¿«ä¸€äº›ï¼Œä½†æˆ‘æ— æ³•ç¡®ä¿è¿™æ ·åšä¸€å®šæ˜¯å¯¹çš„ï¼Œè¯·ä¸€å®šæ³¨æ„ã€‚</p>
<p>å®šä¹‰å¥½äº†SubLayerConnectionï¼Œæˆ‘ä»¬å°±å¯ä»¥å®ç°EncoderLayerçš„ç»“æ„äº†</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">EncoderLayer</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a>    <span class="s2">&quot;EncoderLayer is made up of two sublayer: self-attn and feed forward&quot;</span>                                                                                                         
</span><span id="__span-4-3"><a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">self_attn</span><span class="p">,</span> <span class="n">feed_forward</span><span class="p">,</span> <span class="n">dropout</span><span class="p">):</span>
</span><span id="__span-4-4"><a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a>        <span class="nb">super</span><span class="p">(</span><span class="n">EncoderLayer</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="__span-4-5"><a id="__codelineno-4-5" name="__codelineno-4-5" href="#__codelineno-4-5"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">self_attn</span> <span class="o">=</span> <span class="n">self_attn</span>
</span><span id="__span-4-6"><a id="__codelineno-4-6" name="__codelineno-4-6" href="#__codelineno-4-6"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">feed_forward</span> <span class="o">=</span> <span class="n">feed_forward</span>
</span><span id="__span-4-7"><a id="__codelineno-4-7" name="__codelineno-4-7" href="#__codelineno-4-7"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sublayer</span> <span class="o">=</span> <span class="n">clones</span><span class="p">(</span><span class="n">SublayerConnection</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">dropout</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>
</span><span id="__span-4-8"><a id="__codelineno-4-8" name="__codelineno-4-8" href="#__codelineno-4-8"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">size</span>   <span class="c1"># embedding&#39;s dimention of model, é»˜è®¤512</span>
</span><span id="__span-4-9"><a id="__codelineno-4-9" name="__codelineno-4-9" href="#__codelineno-4-9"></a>
</span><span id="__span-4-10"><a id="__codelineno-4-10" name="__codelineno-4-10" href="#__codelineno-4-10"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">mask</span><span class="p">):</span>
</span><span id="__span-4-11"><a id="__codelineno-4-11" name="__codelineno-4-11" href="#__codelineno-4-11"></a>        <span class="c1"># attention sub layer</span>
</span><span id="__span-4-12"><a id="__codelineno-4-12" name="__codelineno-4-12" href="#__codelineno-4-12"></a>        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sublayer</span><span class="p">[</span><span class="mi">0</span><span class="p">](</span><span class="n">x</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">self_attn</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">mask</span><span class="p">))</span>
</span><span id="__span-4-13"><a id="__codelineno-4-13" name="__codelineno-4-13" href="#__codelineno-4-13"></a>        <span class="c1"># feed forward sub layer</span>
</span><span id="__span-4-14"><a id="__codelineno-4-14" name="__codelineno-4-14" href="#__codelineno-4-14"></a>        <span class="n">z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sublayer</span><span class="p">[</span><span class="mi">1</span><span class="p">](</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">feed_forward</span><span class="p">)</span>
</span><span id="__span-4-15"><a id="__codelineno-4-15" name="__codelineno-4-15" href="#__codelineno-4-15"></a>        <span class="k">return</span> <span class="n">z</span>
</span></code></pre></div>
<h4 id="23">2.3  æ³¨æ„åŠ›æœºåˆ¶<a class="headerlink" href="#23" title="Permanent link">&para;</a></h4>
<p>äººç±»åœ¨è§‚å¯Ÿäº‹ç‰©æ—¶ï¼Œæ— æ³•åŒæ—¶ä»”ç»†è§‚å¯Ÿçœ¼å‰çš„ä¸€åˆ‡ï¼Œåªèƒ½èšç„¦åˆ°æŸä¸€ä¸ªå±€éƒ¨ã€‚é€šå¸¸æˆ‘ä»¬å¤§è„‘åœ¨ç®€å•äº†è§£çœ¼å‰çš„åœºæ™¯åï¼Œèƒ½å¤Ÿå¾ˆå¿«æŠŠæ³¨æ„åŠ›èšç„¦åˆ°æœ€æœ‰ä»·å€¼çš„å±€éƒ¨æ¥ä»”ç»†è§‚å¯Ÿï¼Œä»è€Œä½œå‡ºæœ‰æ•ˆåˆ¤æ–­ã€‚æˆ–è®¸æ˜¯åŸºäºè¿™æ ·çš„å¯å‘ï¼Œå¤§å®¶æƒ³åˆ°äº†åœ¨ç®—æ³•ä¸­åˆ©ç”¨æ³¨æ„åŠ›æœºåˆ¶ã€‚</p>
<p>æ³¨æ„åŠ›è®¡ç®—ï¼šå®ƒéœ€è¦ä¸‰ä¸ªæŒ‡å®šçš„è¾“å…¥Qï¼ˆqueryï¼‰ï¼ŒKï¼ˆkeyï¼‰ï¼ŒVï¼ˆvalueï¼‰ï¼Œç„¶åé€šè¿‡ä¸‹é¢å…¬å¼å¾—åˆ°æ³¨æ„åŠ›çš„è®¡ç®—ç»“æœã€‚</p>
<p><img alt="attention.jpg" src="../../../imgs/llm/chapter00/attention.jpg" /></p>
<p>è®¡ç®—æµç¨‹å›¾å¦‚ä¸‹ï¼š</p>
<p><img alt="atten.jpg" src="../../../imgs/llm/chapter00/atten.jpg" /></p>
<p>ä¸‹é¢æ˜¯æ³¨æ„åŠ›æ¨¡å—çš„å®ç°ä»£ç ï¼š</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">attention</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dropout</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="__span-5-2"><a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a>    <span class="s2">&quot;Compute &#39;Scaled Dot Product Attention&#39;&quot;</span>
</span><span id="__span-5-3"><a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a>
</span><span id="__span-5-4"><a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a>    <span class="c1">#é¦–å…ˆå–queryçš„æœ€åä¸€ç»´çš„å¤§å°ï¼Œå¯¹åº”è¯åµŒå…¥ç»´åº¦</span>
</span><span id="__span-5-5"><a id="__codelineno-5-5" name="__codelineno-5-5" href="#__codelineno-5-5"></a>    <span class="n">d_k</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span><span id="__span-5-6"><a id="__codelineno-5-6" name="__codelineno-5-6" href="#__codelineno-5-6"></a>    <span class="c1">#æŒ‰ç…§æ³¨æ„åŠ›å…¬å¼ï¼Œå°†queryä¸keyçš„è½¬ç½®ç›¸ä¹˜ï¼Œè¿™é‡Œé¢keyæ˜¯å°†æœ€åä¸¤ä¸ªç»´åº¦è¿›è¡Œè½¬ç½®ï¼Œå†é™¤ä»¥ç¼©æ”¾ç³»æ•°å¾—åˆ°æ³¨æ„åŠ›å¾—åˆ†å¼ é‡scores</span>
</span><span id="__span-5-7"><a id="__codelineno-5-7" name="__codelineno-5-7" href="#__codelineno-5-7"></a>    <span class="n">scores</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">key</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="o">/</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">d_k</span><span class="p">)</span>
</span><span id="__span-5-8"><a id="__codelineno-5-8" name="__codelineno-5-8" href="#__codelineno-5-8"></a>
</span><span id="__span-5-9"><a id="__codelineno-5-9" name="__codelineno-5-9" href="#__codelineno-5-9"></a>    <span class="c1">#æ¥ç€åˆ¤æ–­æ˜¯å¦ä½¿ç”¨æ©ç å¼ é‡</span>
</span><span id="__span-5-10"><a id="__codelineno-5-10" name="__codelineno-5-10" href="#__codelineno-5-10"></a>    <span class="k">if</span> <span class="n">mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-5-11"><a id="__codelineno-5-11" name="__codelineno-5-11" href="#__codelineno-5-11"></a>        <span class="c1">#ä½¿ç”¨tensorçš„masked_fillæ–¹æ³•ï¼Œå°†æ©ç å¼ é‡å’Œscoreså¼ é‡æ¯ä¸ªä½ç½®ä¸€ä¸€æ¯”è¾ƒï¼Œå¦‚æœæ©ç å¼ é‡åˆ™å¯¹åº”çš„scoreså¼ é‡ç”¨-1e9è¿™ä¸ªç½®æ¥æ›¿æ¢</span>
</span><span id="__span-5-12"><a id="__codelineno-5-12" name="__codelineno-5-12" href="#__codelineno-5-12"></a>        <span class="n">scores</span> <span class="o">=</span> <span class="n">scores</span><span class="o">.</span><span class="n">masked_fill</span><span class="p">(</span><span class="n">mask</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mf">1e9</span><span class="p">)</span>
</span><span id="__span-5-13"><a id="__codelineno-5-13" name="__codelineno-5-13" href="#__codelineno-5-13"></a>
</span><span id="__span-5-14"><a id="__codelineno-5-14" name="__codelineno-5-14" href="#__codelineno-5-14"></a>    <span class="c1">#å¯¹scoresçš„æœ€åä¸€ç»´è¿›è¡Œsoftmaxæ“ä½œï¼Œä½¿ç”¨F.softmaxæ–¹æ³•ï¼Œè¿™æ ·è·å¾—æœ€ç»ˆçš„æ³¨æ„åŠ›å¼ é‡</span>
</span><span id="__span-5-15"><a id="__codelineno-5-15" name="__codelineno-5-15" href="#__codelineno-5-15"></a>    <span class="n">p_attn</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">softmax</span><span class="p">(</span><span class="n">scores</span><span class="p">,</span> <span class="n">dim</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span><span id="__span-5-16"><a id="__codelineno-5-16" name="__codelineno-5-16" href="#__codelineno-5-16"></a>
</span><span id="__span-5-17"><a id="__codelineno-5-17" name="__codelineno-5-17" href="#__codelineno-5-17"></a>    <span class="c1">#ä¹‹ååˆ¤æ–­æ˜¯å¦ä½¿ç”¨dropoutè¿›è¡Œéšæœºç½®0</span>
</span><span id="__span-5-18"><a id="__codelineno-5-18" name="__codelineno-5-18" href="#__codelineno-5-18"></a>    <span class="k">if</span> <span class="n">dropout</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-5-19"><a id="__codelineno-5-19" name="__codelineno-5-19" href="#__codelineno-5-19"></a>        <span class="n">p_attn</span> <span class="o">=</span> <span class="n">dropout</span><span class="p">(</span><span class="n">p_attn</span><span class="p">)</span>
</span><span id="__span-5-20"><a id="__codelineno-5-20" name="__codelineno-5-20" href="#__codelineno-5-20"></a>
</span><span id="__span-5-21"><a id="__codelineno-5-21" name="__codelineno-5-21" href="#__codelineno-5-21"></a>    <span class="c1">#æœ€åï¼Œæ ¹æ®å…¬å¼å°†p_attnä¸valueå¼ é‡ç›¸ä¹˜è·å¾—æœ€ç»ˆçš„queryæ³¨æ„åŠ›è¡¨ç¤ºï¼ŒåŒæ—¶è¿”å›æ³¨æ„åŠ›å¼ é‡</span>
</span><span id="__span-5-22"><a id="__codelineno-5-22" name="__codelineno-5-22" href="#__codelineno-5-22"></a>    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">p_attn</span><span class="p">,</span> <span class="n">value</span><span class="p">),</span> <span class="n">p_attn</span>
</span></code></pre></div>
<div class="admonition info">
<p class="admonition-title">Info</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a><span class="n">tensor</span><span class="o">.</span><span class="n">masked_fill</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>    
</span></code></pre></div>
<ul>
<li><strong>mask</strong>ï¼šä¸€ä¸ªå¸ƒå°”ç±»å‹ï¼ˆboolï¼‰çš„å¼ é‡ï¼Œå½¢çŠ¶è¦ä¸ tensor å¹¿æ’­å…¼å®¹</li>
<li><strong>value</strong>ï¼šè¦å¡«å……è¿›å»çš„å€¼ï¼ˆé€šå¸¸æ˜¯è´Ÿæ— ç©· -infï¼Œæˆ– 0ï¼‰</li>
</ul>
</div>
<h4 id="24">2.4 å¤šå¤´æ³¨æ„åŠ›æœºåˆ¶<a class="headerlink" href="#24" title="Permanent link">&para;</a></h4>
<p>åˆšåˆšä»‹ç»äº†attentionæœºåˆ¶ï¼Œåœ¨æ­å»ºEncoderLayeræ—¶å€™æ‰€ä½¿ç”¨çš„Attentionæ¨¡å—ï¼Œå®é™…ä½¿ç”¨çš„æ˜¯å¤šå¤´æ³¨æ„åŠ›ï¼Œå¯ä»¥ç®€å•ç†è§£ä¸ºå¤šä¸ªæ³¨æ„åŠ›æ¨¡å—ç»„åˆåœ¨ä¸€èµ·ã€‚</p>
<p><img alt="multi-attention.jpg" src="../../../imgs/llm/chapter00/multi-attention.jpg" /></p>
<p>å¤šå¤´æ³¨æ„åŠ›æœºåˆ¶çš„ä½œç”¨ï¼šè¿™ç§ç»“æ„è®¾è®¡èƒ½è®©æ¯ä¸ªæ³¨æ„åŠ›æœºåˆ¶å»ä¼˜åŒ–æ¯ä¸ªè¯æ±‡çš„ä¸åŒç‰¹å¾éƒ¨åˆ†ï¼Œä»è€Œå‡è¡¡åŒä¸€ç§æ³¨æ„åŠ›æœºåˆ¶å¯èƒ½äº§ç”Ÿçš„åå·®ï¼Œè®©è¯ä¹‰æ‹¥æœ‰æ¥è‡ªæ›´å¤šå…ƒè¡¨è¾¾ï¼Œå®éªŒè¡¨æ˜å¯ä»¥ä»è€Œæå‡æ¨¡å‹æ•ˆæœã€‚</p>
<p>ä¸¾ä¸ªæ›´å½¢è±¡çš„ä¾‹å­ï¼Œbankæ˜¯é“¶è¡Œçš„æ„æ€ï¼Œå¦‚æœåªæœ‰ä¸€ä¸ªæ³¨æ„åŠ›æ¨¡å—ï¼Œé‚£ä¹ˆå®ƒå¤§æ¦‚ç‡ä¼šå­¦ä¹ å»å…³æ³¨ç±»ä¼¼moneyã€loanè´·æ¬¾è¿™æ ·çš„è¯ã€‚å¦‚æœæˆ‘ä»¬ä½¿ç”¨å¤šä¸ªå¤šå¤´æœºåˆ¶ï¼Œé‚£ä¹ˆä¸åŒçš„å¤´å°±ä¼šå»å…³æ³¨ä¸åŒçš„è¯­ä¹‰ï¼Œæ¯”å¦‚bankè¿˜æœ‰ä¸€ç§å«ä¹‰æ˜¯æ²³å²¸ï¼Œé‚£ä¹ˆå¯èƒ½æœ‰ä¸€ä¸ªå¤´å°±ä¼šå»å…³æ³¨ç±»ä¼¼riverè¿™æ ·çš„è¯æ±‡ï¼Œè¿™æ—¶å¤šå¤´æ³¨æ„åŠ›çš„ä»·å€¼å°±ä½“ç°å‡ºæ¥äº†ã€‚</p>
<p>ä¸‹é¢æ˜¯å¤šå¤´æ³¨æ„åŠ›æœºåˆ¶çš„å®ç°ä»£ç ï¼š</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">MultiHeadedAttention</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
</span><span id="__span-7-2"><a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">d_model</span><span class="p">,</span> <span class="n">dropout</span><span class="o">=</span><span class="mf">0.1</span><span class="p">):</span>
</span><span id="__span-7-3"><a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a>        <span class="c1">#åœ¨ç±»çš„åˆå§‹åŒ–æ—¶ï¼Œä¼šä¼ å…¥ä¸‰ä¸ªå‚æ•°ï¼Œhä»£è¡¨å¤´æ•°ï¼Œd_modelä»£è¡¨è¯åµŒå…¥çš„ç»´åº¦ï¼Œdropoutä»£è¡¨è¿›è¡Œdropoutæ“ä½œæ—¶ç½®0æ¯”ç‡ï¼Œé»˜è®¤æ˜¯0.1</span>
</span><span id="__span-7-4"><a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a>        <span class="nb">super</span><span class="p">(</span><span class="n">MultiHeadedAttention</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="__span-7-5"><a id="__codelineno-7-5" name="__codelineno-7-5" href="#__codelineno-7-5"></a>        <span class="c1">#åœ¨å‡½æ•°ä¸­ï¼Œé¦–å…ˆä½¿ç”¨äº†ä¸€ä¸ªæµ‹è¯•ä¸­å¸¸ç”¨çš„assertè¯­å¥ï¼Œåˆ¤æ–­hæ˜¯å¦èƒ½è¢«d_modelæ•´é™¤ï¼Œè¿™æ˜¯å› ä¸ºæˆ‘ä»¬ä¹‹åè¦ç»™æ¯ä¸ªå¤´åˆ†é…ç­‰é‡çš„è¯ç‰¹å¾ï¼Œä¹Ÿå°±æ˜¯embedding_dim/headä¸ª</span>
</span><span id="__span-7-6"><a id="__codelineno-7-6" name="__codelineno-7-6" href="#__codelineno-7-6"></a>        <span class="k">assert</span> <span class="n">d_model</span> <span class="o">%</span> <span class="n">h</span> <span class="o">==</span> <span class="mi">0</span>
</span><span id="__span-7-7"><a id="__codelineno-7-7" name="__codelineno-7-7" href="#__codelineno-7-7"></a>        <span class="c1">#å¾—åˆ°æ¯ä¸ªå¤´è·å¾—çš„åˆ†å‰²è¯å‘é‡ç»´åº¦d_k</span>
</span><span id="__span-7-8"><a id="__codelineno-7-8" name="__codelineno-7-8" href="#__codelineno-7-8"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">d_k</span> <span class="o">=</span> <span class="n">d_model</span> <span class="o">//</span> <span class="n">h</span>
</span><span id="__span-7-9"><a id="__codelineno-7-9" name="__codelineno-7-9" href="#__codelineno-7-9"></a>        <span class="c1">#ä¼ å…¥å¤´æ•°h</span>
</span><span id="__span-7-10"><a id="__codelineno-7-10" name="__codelineno-7-10" href="#__codelineno-7-10"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">h</span> <span class="o">=</span> <span class="n">h</span>
</span><span id="__span-7-11"><a id="__codelineno-7-11" name="__codelineno-7-11" href="#__codelineno-7-11"></a>
</span><span id="__span-7-12"><a id="__codelineno-7-12" name="__codelineno-7-12" href="#__codelineno-7-12"></a>        <span class="c1">#åˆ›å»ºlinearå±‚ï¼Œé€šè¿‡nnçš„Linearå®ä¾‹åŒ–ï¼Œå®ƒçš„å†…éƒ¨å˜æ¢çŸ©é˜µæ˜¯embedding_dim x embedding_dimï¼Œç„¶åä½¿ç”¨ï¼Œä¸ºä»€ä¹ˆæ˜¯å››ä¸ªå‘¢ï¼Œè¿™æ˜¯å› ä¸ºåœ¨å¤šå¤´æ³¨æ„åŠ›ä¸­ï¼ŒQ,K,Vå„éœ€è¦ä¸€ä¸ªï¼Œæœ€åæ‹¼æ¥çš„çŸ©é˜µè¿˜éœ€è¦ä¸€ä¸ªï¼Œå› æ­¤ä¸€å…±æ˜¯å››ä¸ª</span>
</span><span id="__span-7-13"><a id="__codelineno-7-13" name="__codelineno-7-13" href="#__codelineno-7-13"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">linears</span> <span class="o">=</span> <span class="n">clones</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">d_model</span><span class="p">,</span> <span class="n">d_model</span><span class="p">),</span> <span class="mi">4</span><span class="p">)</span>
</span><span id="__span-7-14"><a id="__codelineno-7-14" name="__codelineno-7-14" href="#__codelineno-7-14"></a>        <span class="c1">#self.attnä¸ºNoneï¼Œå®ƒä»£è¡¨æœ€åå¾—åˆ°çš„æ³¨æ„åŠ›å¼ é‡ï¼Œç°åœ¨è¿˜æ²¡æœ‰ç»“æœæ‰€ä»¥ä¸ºNone</span>
</span><span id="__span-7-15"><a id="__codelineno-7-15" name="__codelineno-7-15" href="#__codelineno-7-15"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">attn</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-7-16"><a id="__codelineno-7-16" name="__codelineno-7-16" href="#__codelineno-7-16"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dropout</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="n">p</span><span class="o">=</span><span class="n">dropout</span><span class="p">)</span>
</span><span id="__span-7-17"><a id="__codelineno-7-17" name="__codelineno-7-17" href="#__codelineno-7-17"></a>
</span><span id="__span-7-18"><a id="__codelineno-7-18" name="__codelineno-7-18" href="#__codelineno-7-18"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="__span-7-19"><a id="__codelineno-7-19" name="__codelineno-7-19" href="#__codelineno-7-19"></a>        <span class="c1">#å‰å‘é€»è¾‘å‡½æ•°ï¼Œå®ƒè¾“å…¥å‚æ•°æœ‰å››ä¸ªï¼Œå‰ä¸‰ä¸ªå°±æ˜¯æ³¨æ„åŠ›æœºåˆ¶éœ€è¦çš„Q,K,Vï¼Œæœ€åä¸€ä¸ªæ˜¯æ³¨æ„åŠ›æœºåˆ¶ä¸­å¯èƒ½éœ€è¦çš„maskæ©ç å¼ é‡ï¼Œé»˜è®¤æ˜¯None</span>
</span><span id="__span-7-20"><a id="__codelineno-7-20" name="__codelineno-7-20" href="#__codelineno-7-20"></a>        <span class="k">if</span> <span class="n">mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-7-21"><a id="__codelineno-7-21" name="__codelineno-7-21" href="#__codelineno-7-21"></a>            <span class="c1"># Same mask applied to all h heads.</span>
</span><span id="__span-7-22"><a id="__codelineno-7-22" name="__codelineno-7-22" href="#__codelineno-7-22"></a>            <span class="c1">#ä½¿ç”¨unsqueezeæ‰©å±•ç»´åº¦ï¼Œä»£è¡¨å¤šå¤´ä¸­çš„ç¬¬nå¤´</span>
</span><span id="__span-7-23"><a id="__codelineno-7-23" name="__codelineno-7-23" href="#__codelineno-7-23"></a>            <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span id="__span-7-24"><a id="__codelineno-7-24" name="__codelineno-7-24" href="#__codelineno-7-24"></a>        <span class="c1">#æ¥ç€ï¼Œæˆ‘ä»¬è·å¾—ä¸€ä¸ªbatch_sizeçš„å˜é‡ï¼Œä»–æ˜¯queryå°ºå¯¸çš„ç¬¬1ä¸ªæ•°å­—ï¼Œä»£è¡¨æœ‰å¤šå°‘æ¡æ ·æœ¬</span>
</span><span id="__span-7-25"><a id="__codelineno-7-25" name="__codelineno-7-25" href="#__codelineno-7-25"></a>        <span class="n">nbatches</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="__span-7-26"><a id="__codelineno-7-26" name="__codelineno-7-26" href="#__codelineno-7-26"></a>
</span><span id="__span-7-27"><a id="__codelineno-7-27" name="__codelineno-7-27" href="#__codelineno-7-27"></a>        <span class="c1"># 1) Do all the linear projections in batch from d_model =&gt; h x d_k </span>
</span><span id="__span-7-28"><a id="__codelineno-7-28" name="__codelineno-7-28" href="#__codelineno-7-28"></a>        <span class="c1"># é¦–å…ˆåˆ©ç”¨zipå°†è¾“å…¥QKVä¸ä¸‰ä¸ªçº¿æ€§å±‚ç»„åˆ°ä¸€èµ·ï¼Œç„¶ååˆ©ç”¨forå¾ªç¯ï¼Œå°†è¾“å…¥QKVåˆ†åˆ«ä¼ åˆ°çº¿æ€§å±‚ä¸­ï¼Œåšå®Œçº¿æ€§å˜æ¢åï¼Œå¼€å§‹ä¸ºæ¯ä¸ªå¤´åˆ†å‰²è¾“å…¥ï¼Œè¿™é‡Œä½¿ç”¨viewæ–¹æ³•å¯¹çº¿æ€§å˜æ¢çš„ç»“æ„è¿›è¡Œç»´åº¦é‡å¡‘ï¼Œå¤šåŠ äº†ä¸€ä¸ªç»´åº¦hä»£è¡¨å¤´ï¼Œè¿™æ ·å°±æ„å‘³ç€æ¯ä¸ªå¤´å¯ä»¥è·å¾—ä¸€éƒ¨åˆ†è¯ç‰¹å¾ç»„æˆçš„å¥å­ï¼Œå…¶ä¸­çš„-1ä»£è¡¨è‡ªé€‚åº”ç»´åº¦ï¼Œè®¡ç®—æœºä¼šæ ¹æ®è¿™ç§å˜æ¢è‡ªåŠ¨è®¡ç®—è¿™é‡Œçš„å€¼ï¼Œç„¶åå¯¹ç¬¬äºŒç»´å’Œç¬¬ä¸‰ç»´è¿›è¡Œè½¬ç½®æ“ä½œï¼Œä¸ºäº†è®©ä»£è¡¨å¥å­é•¿åº¦ç»´åº¦å’Œè¯å‘é‡ç»´åº¦èƒ½å¤Ÿç›¸é‚»ï¼Œè¿™æ ·æ³¨æ„åŠ›æœºåˆ¶æ‰èƒ½æ‰¾åˆ°è¯ä¹‰ä¸å¥å­ä½ç½®çš„å…³ç³»ï¼Œä»attentionå‡½æ•°ä¸­å¯ä»¥çœ‹åˆ°ï¼Œåˆ©ç”¨çš„æ˜¯åŸå§‹è¾“å…¥çš„å€’æ•°ç¬¬ä¸€å’Œç¬¬äºŒç»´ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¾—åˆ°äº†æ¯ä¸ªå¤´çš„è¾“å…¥</span>
</span><span id="__span-7-29"><a id="__codelineno-7-29" name="__codelineno-7-29" href="#__codelineno-7-29"></a>        <span class="n">query</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> \
</span><span id="__span-7-30"><a id="__codelineno-7-30" name="__codelineno-7-30" href="#__codelineno-7-30"></a>            <span class="p">[</span><span class="n">l</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">nbatches</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">d_k</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
</span><span id="__span-7-31"><a id="__codelineno-7-31" name="__codelineno-7-31" href="#__codelineno-7-31"></a>             <span class="k">for</span> <span class="n">l</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">linears</span><span class="p">,</span> <span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">))]</span>
</span><span id="__span-7-32"><a id="__codelineno-7-32" name="__codelineno-7-32" href="#__codelineno-7-32"></a>
</span><span id="__span-7-33"><a id="__codelineno-7-33" name="__codelineno-7-33" href="#__codelineno-7-33"></a>        <span class="c1"># 2) Apply attention on all the projected vectors in batch. </span>
</span><span id="__span-7-34"><a id="__codelineno-7-34" name="__codelineno-7-34" href="#__codelineno-7-34"></a>        <span class="c1"># å¾—åˆ°æ¯ä¸ªå¤´çš„è¾“å…¥åï¼Œæ¥ä¸‹æ¥å°±æ˜¯å°†ä»–ä»¬ä¼ å…¥åˆ°attentionä¸­ï¼Œè¿™é‡Œç›´æ¥è°ƒç”¨æˆ‘ä»¬ä¹‹å‰å®ç°çš„attentionå‡½æ•°ï¼ŒåŒæ—¶ä¹Ÿå°†maskå’Œdropoutä¼ å…¥å…¶ä¸­</span>
</span><span id="__span-7-35"><a id="__codelineno-7-35" name="__codelineno-7-35" href="#__codelineno-7-35"></a>        <span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">attn</span> <span class="o">=</span> <span class="n">attention</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">,</span> 
</span><span id="__span-7-36"><a id="__codelineno-7-36" name="__codelineno-7-36" href="#__codelineno-7-36"></a>                                 <span class="n">dropout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dropout</span><span class="p">)</span>
</span><span id="__span-7-37"><a id="__codelineno-7-37" name="__codelineno-7-37" href="#__codelineno-7-37"></a>
</span><span id="__span-7-38"><a id="__codelineno-7-38" name="__codelineno-7-38" href="#__codelineno-7-38"></a>        <span class="c1"># 3) &quot;Concat&quot; using a view and apply a final linear. </span>
</span><span id="__span-7-39"><a id="__codelineno-7-39" name="__codelineno-7-39" href="#__codelineno-7-39"></a>        <span class="c1"># é€šè¿‡å¤šå¤´æ³¨æ„åŠ›è®¡ç®—åï¼Œæˆ‘ä»¬å°±å¾—åˆ°äº†æ¯ä¸ªå¤´è®¡ç®—ç»“æœç»„æˆçš„4ç»´å¼ é‡ï¼Œæˆ‘ä»¬éœ€è¦å°†å…¶è½¬æ¢ä¸ºè¾“å…¥çš„å½¢çŠ¶ä»¥æ–¹ä¾¿åç»­çš„è®¡ç®—ï¼Œå› æ­¤è¿™é‡Œå¼€å§‹è¿›è¡Œç¬¬ä¸€æ­¥å¤„ç†ç¯èŠ‚çš„é€†æ“ä½œï¼Œå…ˆå¯¹ç¬¬äºŒå’Œç¬¬ä¸‰ç»´è¿›è¡Œè½¬ç½®ï¼Œç„¶åä½¿ç”¨contiguousæ–¹æ³•ã€‚è¿™ä¸ªæ–¹æ³•çš„ä½œç”¨å°±æ˜¯èƒ½å¤Ÿè®©è½¬ç½®åçš„å¼ é‡åº”ç”¨viewæ–¹æ³•ï¼Œå¦åˆ™å°†æ— æ³•ç›´æ¥ä½¿ç”¨ï¼Œæ‰€ä»¥ï¼Œä¸‹ä¸€æ­¥å°±æ˜¯ä½¿ç”¨viewé‡å¡‘å½¢çŠ¶ï¼Œå˜æˆå’Œè¾“å…¥å½¢çŠ¶ç›¸åŒã€‚  </span>
</span><span id="__span-7-40"><a id="__codelineno-7-40" name="__codelineno-7-40" href="#__codelineno-7-40"></a>        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">contiguous</span><span class="p">()</span> \
</span><span id="__span-7-41"><a id="__codelineno-7-41" name="__codelineno-7-41" href="#__codelineno-7-41"></a>             <span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">nbatches</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">d_k</span><span class="p">)</span>
</span><span id="__span-7-42"><a id="__codelineno-7-42" name="__codelineno-7-42" href="#__codelineno-7-42"></a>        <span class="c1">#æœ€åä½¿ç”¨çº¿æ€§å±‚åˆ—è¡¨ä¸­çš„æœ€åä¸€ä¸ªçº¿æ€§å˜æ¢å¾—åˆ°æœ€ç»ˆçš„å¤šå¤´æ³¨æ„åŠ›ç»“æ„çš„è¾“å‡º</span>
</span><span id="__span-7-43"><a id="__codelineno-7-43" name="__codelineno-7-43" href="#__codelineno-7-43"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">linears</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">](</span><span class="n">x</span><span class="p">)</span>
</span></code></pre></div>
<h4 id="25">2.5  å‰é¦ˆå…¨è¿æ¥å±‚<a class="headerlink" href="#25" title="Permanent link">&para;</a></h4>
<p>EncoderLayerä¸­å¦ä¸€ä¸ªæ ¸å¿ƒçš„å­å±‚æ˜¯ Feed Forward Layerï¼Œæˆ‘ä»¬è¿™å°±ä»‹ç»ä¸€ä¸‹ã€‚</p>
<p>åœ¨è¿›è¡Œäº†Attentionæ“ä½œä¹‹åï¼Œencoderå’Œdecoderä¸­çš„æ¯ä¸€å±‚éƒ½åŒ…å«äº†ä¸€ä¸ªå…¨è¿æ¥å‰å‘ç½‘ç»œï¼Œå¯¹æ¯ä¸ªpositionçš„å‘é‡åˆ†åˆ«è¿›è¡Œç›¸åŒçš„æ“ä½œï¼ŒåŒ…æ‹¬ä¸¤ä¸ªçº¿æ€§å˜æ¢å’Œä¸€ä¸ªReLUæ¿€æ´»è¾“å‡ºï¼š</p>
<p><img alt="ffn.jpg" src="../../../imgs/llm/chapter00/ffn.jpg" /></p>
<p>Feed Forward Layer å…¶å®å°±æ˜¯ç®€å•çš„ç”±ä¸¤ä¸ªå‰å‘å…¨è¿æ¥å±‚ç»„æˆï¼Œæ ¸å¿ƒåœ¨äºï¼ŒAttentionæ¨¡å—æ¯ä¸ªæ—¶é—´æ­¥çš„è¾“å‡ºéƒ½æ•´åˆäº†æ‰€æœ‰æ—¶é—´æ­¥çš„ä¿¡æ¯ï¼Œè€ŒFeed Forward Layeræ¯ä¸ªæ—¶é—´æ­¥åªæ˜¯å¯¹è‡ªå·±çš„ç‰¹å¾çš„ä¸€ä¸ªè¿›ä¸€æ­¥æ•´åˆï¼Œä¸å…¶ä»–æ—¶é—´æ­¥æ— å…³ã€‚</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">PositionwiseFeedForward</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
</span><span id="__span-8-2"><a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">d_model</span><span class="p">,</span> <span class="n">d_ff</span><span class="p">,</span> <span class="n">dropout</span><span class="o">=</span><span class="mf">0.1</span><span class="p">):</span>
</span><span id="__span-8-3"><a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a>        <span class="c1">#åˆå§‹åŒ–å‡½æ•°æœ‰ä¸‰ä¸ªè¾“å…¥å‚æ•°åˆ†åˆ«æ˜¯d_modelï¼Œd_ffï¼Œå’Œdropout=0.1ï¼Œç¬¬ä¸€ä¸ªæ˜¯çº¿æ€§å±‚çš„è¾“å…¥ç»´åº¦ä¹Ÿæ˜¯ç¬¬äºŒä¸ªçº¿æ€§å±‚çš„è¾“å‡ºç»´åº¦ï¼Œå› ä¸ºæˆ‘ä»¬å¸Œæœ›è¾“å…¥é€šè¿‡å‰é¦ˆå…¨è¿æ¥å±‚åè¾“å…¥å’Œè¾“å‡ºçš„ç»´åº¦ä¸å˜ï¼Œç¬¬äºŒä¸ªå‚æ•°d_ffå°±æ˜¯ç¬¬äºŒä¸ªçº¿æ€§å±‚çš„è¾“å…¥ç»´åº¦å’Œç¬¬ä¸€ä¸ªçº¿æ€§å±‚çš„è¾“å‡ºï¼Œæœ€åä¸€ä¸ªæ˜¯dropoutç½®0æ¯”ç‡ã€‚</span>
</span><span id="__span-8-4"><a id="__codelineno-8-4" name="__codelineno-8-4" href="#__codelineno-8-4"></a>        <span class="nb">super</span><span class="p">(</span><span class="n">PositionwiseFeedForward</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="__span-8-5"><a id="__codelineno-8-5" name="__codelineno-8-5" href="#__codelineno-8-5"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">w_1</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">d_model</span><span class="p">,</span> <span class="n">d_ff</span><span class="p">)</span>
</span><span id="__span-8-6"><a id="__codelineno-8-6" name="__codelineno-8-6" href="#__codelineno-8-6"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">w_2</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">d_ff</span><span class="p">,</span> <span class="n">d_model</span><span class="p">)</span>
</span><span id="__span-8-7"><a id="__codelineno-8-7" name="__codelineno-8-7" href="#__codelineno-8-7"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dropout</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="n">dropout</span><span class="p">)</span>
</span><span id="__span-8-8"><a id="__codelineno-8-8" name="__codelineno-8-8" href="#__codelineno-8-8"></a>
</span><span id="__span-8-9"><a id="__codelineno-8-9" name="__codelineno-8-9" href="#__codelineno-8-9"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
</span><span id="__span-8-10"><a id="__codelineno-8-10" name="__codelineno-8-10" href="#__codelineno-8-10"></a>        <span class="c1">#è¾“å…¥å‚æ•°ä¸ºxï¼Œä»£è¡¨æ¥è‡ªä¸Šä¸€å±‚çš„è¾“å‡ºï¼Œé¦–å…ˆç»è¿‡ç¬¬ä¸€ä¸ªçº¿æ€§å±‚ï¼Œç„¶åä½¿ç”¨Fä¸­çš„reluå‡½æ•°è¿›è¡Œæ¿€æ´»ï¼Œä¹‹åå†ä½¿ç”¨dropoutè¿›è¡Œéšæœºç½®0ï¼Œæœ€åé€šè¿‡ç¬¬äºŒä¸ªçº¿æ€§å±‚w2ï¼Œè¿”å›æœ€ç»ˆç»“æœ</span>
</span><span id="__span-8-11"><a id="__codelineno-8-11" name="__codelineno-8-11" href="#__codelineno-8-11"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">w_2</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dropout</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">w_1</span><span class="p">(</span><span class="n">x</span><span class="p">))))</span>
</span></code></pre></div>
<h4 id="26">2.6 è§„èŒƒåŒ–å±‚<a class="headerlink" href="#26" title="Permanent link">&para;</a></h4>
<p>è§„èŒƒåŒ–å±‚çš„ä½œç”¨ï¼šå®ƒæ˜¯æ‰€æœ‰æ·±å±‚ç½‘ç»œæ¨¡å‹éƒ½éœ€è¦çš„æ ‡å‡†ç½‘ç»œå±‚ï¼Œå› ä¸ºéšç€ç½‘ç»œå±‚æ•°çš„å¢åŠ ï¼Œé€šè¿‡å¤šå±‚çš„è®¡ç®—åè¾“å‡ºå¯èƒ½å¼€å§‹å‡ºç°è¿‡å¤§æˆ–è¿‡å°çš„æƒ…å†µï¼Œè¿™æ ·å¯èƒ½ä¼šå¯¼è‡´å­¦ä¹ è¿‡ç¨‹å‡ºç°å¼‚å¸¸ï¼Œæ¨¡å‹å¯èƒ½æ”¶æ•›éå¸¸æ…¢ã€‚å› æ­¤éƒ½ä¼šåœ¨ä¸€å®šå±‚åæ¥è§„èŒƒåŒ–å±‚è¿›è¡Œæ•°å€¼çš„è§„èŒƒåŒ–ï¼Œä½¿å…¶ç‰¹å¾æ•°å€¼åœ¨åˆç†èŒƒå›´å†…ã€‚</p>
<p>Transformerä¸­ä½¿ç”¨çš„normalizationæ‰‹æ®µæ˜¯layer normï¼Œå®ç°ä»£ç å¾ˆç®€å•ï¼Œå¦‚ä¸‹ï¼š</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-9-1"><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">LayerNorm</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
</span><span id="__span-9-2"><a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a>    <span class="s2">&quot;Construct a layernorm module (See citation for details).&quot;</span>
</span><span id="__span-9-3"><a id="__codelineno-9-3" name="__codelineno-9-3" href="#__codelineno-9-3"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">feature_size</span><span class="p">,</span> <span class="n">eps</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">):</span>
</span><span id="__span-9-4"><a id="__codelineno-9-4" name="__codelineno-9-4" href="#__codelineno-9-4"></a>        <span class="c1">#åˆå§‹åŒ–å‡½æ•°æœ‰ä¸¤ä¸ªå‚æ•°ï¼Œä¸€ä¸ªæ˜¯features,è¡¨ç¤ºè¯åµŒå…¥çš„ç»´åº¦,å¦ä¸€ä¸ªæ˜¯epså®ƒæ˜¯ä¸€ä¸ªè¶³å¤Ÿå°çš„æ•°ï¼Œåœ¨è§„èŒƒåŒ–å…¬å¼çš„åˆ†æ¯ä¸­å‡ºç°,é˜²æ­¢åˆ†æ¯ä¸º0ï¼Œé»˜è®¤æ˜¯1e-6ã€‚</span>
</span><span id="__span-9-5"><a id="__codelineno-9-5" name="__codelineno-9-5" href="#__codelineno-9-5"></a>        <span class="nb">super</span><span class="p">(</span><span class="n">LayerNorm</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="__span-9-6"><a id="__codelineno-9-6" name="__codelineno-9-6" href="#__codelineno-9-6"></a>        <span class="c1">#æ ¹æ®featuresçš„å½¢çŠ¶åˆå§‹åŒ–ä¸¤ä¸ªå‚æ•°å¼ é‡a2ï¼Œå’Œb2ï¼Œç¬¬ä¸€åˆå§‹åŒ–ä¸º1å¼ é‡ï¼Œä¹Ÿå°±æ˜¯é‡Œé¢çš„å…ƒç´ éƒ½æ˜¯1ï¼Œç¬¬äºŒä¸ªåˆå§‹åŒ–ä¸º0å¼ é‡ï¼Œä¹Ÿå°±æ˜¯é‡Œé¢çš„å…ƒç´ éƒ½æ˜¯0ï¼Œè¿™ä¸¤ä¸ªå¼ é‡å°±æ˜¯è§„èŒƒåŒ–å±‚çš„å‚æ•°ã€‚å› ä¸ºç›´æ¥å¯¹ä¸Šä¸€å±‚å¾—åˆ°çš„ç»“æœåšè§„èŒƒåŒ–å…¬å¼è®¡ç®—ï¼Œå°†æ”¹å˜ç»“æœçš„æ­£å¸¸è¡¨å¾ï¼Œå› æ­¤å°±éœ€è¦æœ‰å‚æ•°ä½œä¸ºè°ƒèŠ‚å› å­ï¼Œä½¿å…¶å³èƒ½æ»¡è¶³è§„èŒƒåŒ–è¦æ±‚ï¼Œåˆèƒ½ä¸æ”¹å˜é’ˆå¯¹ç›®æ ‡çš„è¡¨å¾ï¼Œæœ€åä½¿ç”¨nn.parameterå°è£…ï¼Œä»£è¡¨ä»–ä»¬æ˜¯æ¨¡å‹çš„å‚æ•°</span>
</span><span id="__span-9-7"><a id="__codelineno-9-7" name="__codelineno-9-7" href="#__codelineno-9-7"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">a_2</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">feature_size</span><span class="p">))</span>
</span><span id="__span-9-8"><a id="__codelineno-9-8" name="__codelineno-9-8" href="#__codelineno-9-8"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">b_2</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">feature_size</span><span class="p">))</span>
</span><span id="__span-9-9"><a id="__codelineno-9-9" name="__codelineno-9-9" href="#__codelineno-9-9"></a>        <span class="c1">#æŠŠepsä¼ åˆ°ç±»ä¸­</span>
</span><span id="__span-9-10"><a id="__codelineno-9-10" name="__codelineno-9-10" href="#__codelineno-9-10"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">eps</span> <span class="o">=</span> <span class="n">eps</span>
</span><span id="__span-9-11"><a id="__codelineno-9-11" name="__codelineno-9-11" href="#__codelineno-9-11"></a>
</span><span id="__span-9-12"><a id="__codelineno-9-12" name="__codelineno-9-12" href="#__codelineno-9-12"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
</span><span id="__span-9-13"><a id="__codelineno-9-13" name="__codelineno-9-13" href="#__codelineno-9-13"></a>    <span class="c1">#è¾“å…¥å‚æ•°xä»£è¡¨æ¥è‡ªä¸Šä¸€å±‚çš„è¾“å‡ºï¼Œåœ¨å‡½æ•°ä¸­ï¼Œé¦–å…ˆå¯¹è¾“å…¥å˜é‡xæ±‚å…¶æœ€åä¸€ä¸ªç»´åº¦çš„å‡å€¼ï¼Œå¹¶ä¿æŒè¾“å‡ºç»´åº¦ä¸è¾“å…¥ç»´åº¦ä¸€è‡´ï¼Œæ¥ç€å†æ±‚æœ€åä¸€ä¸ªç»´åº¦çš„æ ‡å‡†å·®ï¼Œç„¶åå°±æ˜¯æ ¹æ®è§„èŒƒåŒ–å…¬å¼ï¼Œç”¨xå‡å»å‡å€¼é™¤ä»¥æ ‡å‡†å·®è·å¾—è§„èŒƒåŒ–çš„ç»“æœã€‚</span>
</span><span id="__span-9-14"><a id="__codelineno-9-14" name="__codelineno-9-14" href="#__codelineno-9-14"></a>    <span class="c1">#æœ€åå¯¹ç»“æœä¹˜ä»¥æˆ‘ä»¬çš„ç¼©æ”¾å‚æ•°ï¼Œå³a2,*å·ä»£è¡¨åŒå‹ç‚¹ä¹˜ï¼Œå³å¯¹åº”ä½ç½®è¿›è¡Œä¹˜æ³•æ“ä½œï¼ŒåŠ ä¸Šä½ç§»å‚b2ï¼Œè¿”å›å³å¯</span>
</span><span id="__span-9-15"><a id="__codelineno-9-15" name="__codelineno-9-15" href="#__codelineno-9-15"></a>        <span class="n">mean</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdim</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="__span-9-16"><a id="__codelineno-9-16" name="__codelineno-9-16" href="#__codelineno-9-16"></a>        <span class="n">std</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdim</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="__span-9-17"><a id="__codelineno-9-17" name="__codelineno-9-17" href="#__codelineno-9-17"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_2</span> <span class="o">*</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">mean</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">std</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">eps</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_2</span>
</span></code></pre></div>
<h4 id="27">2.7 æ©ç åŠå…¶ä½œç”¨<a class="headerlink" href="#27" title="Permanent link">&para;</a></h4>
<p>æ©ç ï¼šæ©ä»£è¡¨é®æ©ï¼Œç å°±æ˜¯æˆ‘ä»¬å¼ é‡ä¸­çš„æ•°å€¼ï¼Œå®ƒçš„å°ºå¯¸ä¸å®šï¼Œé‡Œé¢ä¸€èˆ¬åªæœ‰0å’Œ1ï¼›ä»£è¡¨ä½ç½®è¢«é®æ©æˆ–è€…ä¸è¢«é®æ©ã€‚</p>
<p>æ©ç çš„ä½œç”¨ï¼šåœ¨transformerä¸­ï¼Œæ©ç ä¸»è¦çš„ä½œç”¨æœ‰ä¸¤ä¸ªï¼Œä¸€ä¸ªæ˜¯å±è”½æ‰æ— æ•ˆçš„paddingåŒºåŸŸï¼Œä¸€ä¸ªæ˜¯å±è”½æ‰æ¥è‡ªâ€œæœªæ¥â€çš„ä¿¡æ¯ã€‚Encoderä¸­çš„æ©ç ä¸»è¦æ˜¯èµ·åˆ°ç¬¬ä¸€ä¸ªä½œç”¨ï¼ŒDecoderä¸­çš„æ©ç åˆ™åŒæ—¶å‘æŒ¥ç€ä¸¤ç§ä½œç”¨ã€‚</p>
<p>å±è”½æ‰æ— æ•ˆçš„paddingåŒºåŸŸï¼šæˆ‘ä»¬è®­ç»ƒéœ€è¦ç»„batchè¿›è¡Œï¼Œå°±ä»¥æœºå™¨ç¿»è¯‘ä»»åŠ¡ä¸ºä¾‹ï¼Œä¸€ä¸ªbatchä¸­ä¸åŒæ ·æœ¬çš„è¾“å…¥é•¿åº¦å¾ˆå¯èƒ½æ˜¯ä¸ä¸€æ ·çš„ï¼Œæ­¤æ—¶æˆ‘ä»¬è¦è®¾ç½®ä¸€ä¸ªæœ€å¤§å¥å­é•¿åº¦ï¼Œç„¶åå¯¹ç©ºç™½åŒºåŸŸè¿›è¡Œpaddingå¡«å……ï¼Œè€Œå¡«å……çš„åŒºåŸŸæ— è®ºåœ¨Encoderè¿˜æ˜¯Decoderçš„è®¡ç®—ä¸­éƒ½æ˜¯æ²¡æœ‰æ„ä¹‰çš„ï¼Œå› æ­¤éœ€è¦ç”¨maskè¿›è¡Œæ ‡è¯†ï¼Œå±è”½æ‰å¯¹åº”åŒºåŸŸçš„å“åº”ã€‚</p>
<p>å±è”½æ‰æ¥è‡ªæœªæ¥çš„ä¿¡æ¯ï¼šæˆ‘ä»¬å·²ç»å­¦ä¹ äº†attentionçš„è®¡ç®—æµç¨‹ï¼Œå®ƒæ˜¯ä¼šç»¼åˆæ‰€æœ‰æ—¶é—´æ­¥çš„è®¡ç®—çš„ï¼Œé‚£ä¹ˆåœ¨è§£ç çš„æ—¶å€™ï¼Œå°±æœ‰å¯èƒ½è·å–åˆ°æœªæ¥çš„ä¿¡æ¯ï¼Œè¿™æ˜¯ä¸è¡Œçš„ã€‚å› æ­¤ï¼Œè¿™ç§æƒ…å†µä¹Ÿéœ€è¦æˆ‘ä»¬ä½¿ç”¨maskè¿›è¡Œå±è”½ã€‚ç°åœ¨è¿˜æ²¡ä»‹ç»åˆ°Decoderï¼Œå¦‚æœæ²¡å®Œå…¨ç†è§£ï¼Œå¯ä»¥ä¹‹åå†å›è¿‡å¤´æ¥æ€è€ƒä¸‹ã€‚</p>
<p>maskçš„æ„é€ ä»£ç å¦‚ä¸‹ï¼š</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-10-1"><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">subsequent_mask</span><span class="p">(</span><span class="n">size</span><span class="p">):</span>
</span><span id="__span-10-2"><a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a>    <span class="c1">#ç”Ÿæˆå‘åé®æ©çš„æ©ç å¼ é‡ï¼Œå‚æ•°sizeæ˜¯æ©ç å¼ é‡æœ€åä¸¤ä¸ªç»´åº¦çš„å¤§å°ï¼Œå®ƒæœ€åä¸¤ç»´å½¢æˆä¸€ä¸ªæ–¹é˜µ</span>
</span><span id="__span-10-3"><a id="__codelineno-10-3" name="__codelineno-10-3" href="#__codelineno-10-3"></a>
</span><span id="__span-10-4"><a id="__codelineno-10-4" name="__codelineno-10-4" href="#__codelineno-10-4"></a>    <span class="s2">&quot;Mask out subsequent positions.&quot;</span>
</span><span id="__span-10-5"><a id="__codelineno-10-5" name="__codelineno-10-5" href="#__codelineno-10-5"></a>    <span class="n">attn_shape</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span>
</span><span id="__span-10-6"><a id="__codelineno-10-6" name="__codelineno-10-6" href="#__codelineno-10-6"></a>
</span><span id="__span-10-7"><a id="__codelineno-10-7" name="__codelineno-10-7" href="#__codelineno-10-7"></a>    <span class="c1">#ç„¶åä½¿ç”¨np.onesæ–¹æ³•å‘è¿™ä¸ªå½¢çŠ¶ä¸­æ·»åŠ 1å…ƒç´ ï¼Œå½¢æˆä¸Šä¸‰è§’é˜µ</span>
</span><span id="__span-10-8"><a id="__codelineno-10-8" name="__codelineno-10-8" href="#__codelineno-10-8"></a>    <span class="n">subsequent_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">triu</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">attn_shape</span><span class="p">),</span> <span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;uint8&#39;</span><span class="p">)</span>
</span><span id="__span-10-9"><a id="__codelineno-10-9" name="__codelineno-10-9" href="#__codelineno-10-9"></a>
</span><span id="__span-10-10"><a id="__codelineno-10-10" name="__codelineno-10-10" href="#__codelineno-10-10"></a>    <span class="c1">#æœ€åå°†numpyç±»å‹è½¬åŒ–ä¸ºtorchä¸­çš„tensorï¼Œå†…éƒ¨åšä¸€ä¸ª1- çš„æ“ä½œã€‚è¿™ä¸ªå…¶å®æ˜¯åšäº†ä¸€ä¸ªä¸‰è§’é˜µçš„åè½¬ï¼Œsubsequent_maskä¸­çš„æ¯ä¸ªå…ƒç´ éƒ½ä¼šè¢«1å‡ã€‚</span>
</span><span id="__span-10-11"><a id="__codelineno-10-11" name="__codelineno-10-11" href="#__codelineno-10-11"></a>    <span class="c1">#å¦‚æœæ˜¯0ï¼Œsubsequent_maskä¸­çš„è¯¥ä½ç½®ç”±0å˜æˆ1</span>
</span><span id="__span-10-12"><a id="__codelineno-10-12" name="__codelineno-10-12" href="#__codelineno-10-12"></a>    <span class="c1">#å¦‚æœæ˜¯1ï¼Œsubsequect_maskä¸­çš„è¯¥ä½ç½®ç”±1å˜æˆ0</span>
</span><span id="__span-10-13"><a id="__codelineno-10-13" name="__codelineno-10-13" href="#__codelineno-10-13"></a>    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">subsequent_mask</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
</span></code></pre></div>
<h3 id="decoder">ä¸‰ã€Decoder<a class="headerlink" href="#decoder" title="Permanent link">&para;</a></h3>
<h4 id="31">3.1 è§£ç å™¨æ•´ä½“ç»“æ„<a class="headerlink" href="#31" title="Permanent link">&para;</a></h4>
<p>è§£ç å™¨çš„ä½œç”¨ï¼šæ ¹æ®ç¼–ç å™¨çš„ç»“æœä»¥åŠä¸Šä¸€æ¬¡é¢„æµ‹çš„ç»“æœï¼Œè¾“å‡ºåºåˆ—çš„ä¸‹ä¸€ä¸ªç»“æœã€‚</p>
<p>æ•´ä½“ç»“æ„ä¸Šï¼Œè§£ç å™¨ä¹Ÿæ˜¯ç”±Nä¸ªç›¸åŒå±‚å †å è€Œæˆã€‚æ„é€ ä»£ç å¦‚ä¸‹ï¼š</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-11-1"><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a><span class="c1">#ä½¿ç”¨ç±»Decoderæ¥å®ç°è§£ç å™¨</span>
</span><span id="__span-11-2"><a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a><span class="k">class</span><span class="w"> </span><span class="nc">Decoder</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
</span><span id="__span-11-3"><a id="__codelineno-11-3" name="__codelineno-11-3" href="#__codelineno-11-3"></a>    <span class="s2">&quot;Generic N layer decoder with masking.&quot;</span>
</span><span id="__span-11-4"><a id="__codelineno-11-4" name="__codelineno-11-4" href="#__codelineno-11-4"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">layer</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
</span><span id="__span-11-5"><a id="__codelineno-11-5" name="__codelineno-11-5" href="#__codelineno-11-5"></a>        <span class="c1">#åˆå§‹åŒ–å‡½æ•°çš„å‚æ•°æœ‰ä¸¤ä¸ªï¼Œç¬¬ä¸€ä¸ªå°±æ˜¯è§£ç å™¨å±‚layerï¼Œç¬¬äºŒä¸ªæ˜¯è§£ç å™¨å±‚çš„ä¸ªæ•°N</span>
</span><span id="__span-11-6"><a id="__codelineno-11-6" name="__codelineno-11-6" href="#__codelineno-11-6"></a>        <span class="nb">super</span><span class="p">(</span><span class="n">Decoder</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="__span-11-7"><a id="__codelineno-11-7" name="__codelineno-11-7" href="#__codelineno-11-7"></a>        <span class="c1">#é¦–å…ˆä½¿ç”¨clonesæ–¹æ³•å…‹éš†äº†Nä¸ªlayerï¼Œç„¶åå®ä¾‹åŒ–ä¸€ä¸ªè§„èŒƒåŒ–å±‚ï¼Œå› ä¸ºæ•°æ®èµ°è¿‡äº†æ‰€æœ‰çš„è§£ç å™¨å±‚åæœ€åè¦åšè§„èŒƒåŒ–å¤„ç†ã€‚</span>
</span><span id="__span-11-8"><a id="__codelineno-11-8" name="__codelineno-11-8" href="#__codelineno-11-8"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">layers</span> <span class="o">=</span> <span class="n">clones</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span>
</span><span id="__span-11-9"><a id="__codelineno-11-9" name="__codelineno-11-9" href="#__codelineno-11-9"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">norm</span> <span class="o">=</span> <span class="n">LayerNorm</span><span class="p">(</span><span class="n">layer</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
</span><span id="__span-11-10"><a id="__codelineno-11-10" name="__codelineno-11-10" href="#__codelineno-11-10"></a>
</span><span id="__span-11-11"><a id="__codelineno-11-11" name="__codelineno-11-11" href="#__codelineno-11-11"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">memory</span><span class="p">,</span> <span class="n">src_mask</span><span class="p">,</span> <span class="n">tgt_mask</span><span class="p">):</span>
</span><span id="__span-11-12"><a id="__codelineno-11-12" name="__codelineno-11-12" href="#__codelineno-11-12"></a>        <span class="c1">#forwardå‡½æ•°ä¸­çš„å‚æ•°æœ‰4ä¸ªï¼Œxä»£è¡¨ç›®æ ‡æ•°æ®çš„åµŒå…¥è¡¨ç¤ºï¼Œmemoryæ˜¯ç¼–ç å™¨å±‚çš„è¾“å‡ºï¼Œsource_maskï¼Œtarget_maskä»£è¡¨æºæ•°æ®å’Œç›®æ ‡æ•°æ®çš„æ©ç å¼ é‡ï¼Œç„¶åå°±æ˜¯å¯¹æ¯ä¸ªå±‚è¿›è¡Œå¾ªç¯ï¼Œå½“ç„¶è¿™ä¸ªå¾ªç¯å°±æ˜¯å˜é‡xé€šè¿‡æ¯ä¸€ä¸ªå±‚çš„å¤„ç†ï¼Œå¾—å‡ºæœ€åçš„ç»“æœï¼Œå†è¿›è¡Œä¸€æ¬¡è§„èŒƒåŒ–è¿”å›å³å¯ã€‚</span>
</span><span id="__span-11-13"><a id="__codelineno-11-13" name="__codelineno-11-13" href="#__codelineno-11-13"></a>        <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="p">:</span>
</span><span id="__span-11-14"><a id="__codelineno-11-14" name="__codelineno-11-14" href="#__codelineno-11-14"></a>            <span class="n">x</span> <span class="o">=</span> <span class="n">layer</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">memory</span><span class="p">,</span> <span class="n">src_mask</span><span class="p">,</span> <span class="n">tgt_mask</span><span class="p">)</span>
</span><span id="__span-11-15"><a id="__codelineno-11-15" name="__codelineno-11-15" href="#__codelineno-11-15"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</span></code></pre></div>
<h4 id="32">3.2 è§£ç å™¨å±‚<a class="headerlink" href="#32" title="Permanent link">&para;</a></h4>
<p>æ¯ä¸ªè§£ç å™¨å±‚ç”±ä¸‰ä¸ªå­å±‚è¿æ¥ç»“æ„ç»„æˆï¼Œç¬¬ä¸€ä¸ªå­å±‚è¿æ¥ç»“æ„åŒ…æ‹¬ä¸€ä¸ªå¤šå¤´è‡ªæ³¨æ„åŠ›å­å±‚å’Œè§„èŒƒåŒ–å±‚ä»¥åŠä¸€ä¸ªæ®‹å·®è¿æ¥ï¼Œç¬¬äºŒä¸ªå­å±‚è¿æ¥ç»“æ„åŒ…æ‹¬ä¸€ä¸ªå¤šå¤´æ³¨æ„åŠ›å­å±‚å’Œè§„èŒƒåŒ–å±‚ä»¥åŠä¸€ä¸ªæ®‹å·®è¿æ¥ï¼Œç¬¬ä¸‰ä¸ªå­å±‚è¿æ¥ç»“æ„åŒ…æ‹¬ä¸€ä¸ªå‰é¦ˆå…¨è¿æ¥å­å±‚å’Œè§„èŒƒåŒ–å±‚ä»¥åŠä¸€ä¸ªæ®‹å·®è¿æ¥ã€‚</p>
<p><img alt="decoder.jpg" src="../../../imgs/llm/chapter00/decoder.jpg" /></p>
<p>è§£ç å™¨å±‚ä¸­çš„å„ä¸ªå­æ¨¡å—ï¼Œå¦‚ï¼Œå¤šå¤´æ³¨æ„åŠ›æœºåˆ¶ï¼Œè§„èŒƒåŒ–å±‚ï¼Œå‰é¦ˆå…¨è¿æ¥éƒ½ä¸ç¼–ç å™¨ä¸­çš„å®ç°ç›¸åŒã€‚</p>
<p>æœ‰ä¸€ä¸ªç»†èŠ‚éœ€è¦æ³¨æ„ï¼Œç¬¬ä¸€ä¸ªå­å±‚çš„å¤šå¤´æ³¨æ„åŠ›å’Œç¼–ç å™¨ä¸­å®Œå…¨ä¸€è‡´ï¼Œç¬¬äºŒä¸ªå­å±‚ï¼Œå®ƒçš„å¤šå¤´æ³¨æ„åŠ›æ¨¡å—ä¸­ï¼Œqueryæ¥è‡ªä¸Šä¸€ä¸ªå­å±‚ï¼Œkey å’Œ value æ¥è‡ªç¼–ç å™¨çš„è¾“å‡ºã€‚å¯ä»¥è¿™æ ·ç†è§£ï¼Œå°±æ˜¯ç¬¬äºŒå±‚è´Ÿè´£ï¼Œåˆ©ç”¨è§£ç å™¨å·²ç»é¢„æµ‹å‡ºçš„ä¿¡æ¯ä½œä¸ºqueryï¼Œå»ç¼–ç å™¨æå–çš„å„ç§ç‰¹å¾ä¸­ï¼ŒæŸ¥æ‰¾ç›¸å…³ä¿¡æ¯å¹¶èåˆåˆ°å½“å‰ç‰¹å¾ä¸­ï¼Œæ¥å®Œæˆé¢„æµ‹ã€‚</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-12-1"><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a><span class="c1">#ä½¿ç”¨DecoderLayerçš„ç±»å®ç°è§£ç å™¨å±‚</span>
</span><span id="__span-12-2"><a id="__codelineno-12-2" name="__codelineno-12-2" href="#__codelineno-12-2"></a><span class="k">class</span><span class="w"> </span><span class="nc">DecoderLayer</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
</span><span id="__span-12-3"><a id="__codelineno-12-3" name="__codelineno-12-3" href="#__codelineno-12-3"></a>    <span class="s2">&quot;Decoder is made of self-attn, src-attn, and feed forward (defined below)&quot;</span>
</span><span id="__span-12-4"><a id="__codelineno-12-4" name="__codelineno-12-4" href="#__codelineno-12-4"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">self_attn</span><span class="p">,</span> <span class="n">src_attn</span><span class="p">,</span> <span class="n">feed_forward</span><span class="p">,</span> <span class="n">dropout</span><span class="p">):</span>
</span><span id="__span-12-5"><a id="__codelineno-12-5" name="__codelineno-12-5" href="#__codelineno-12-5"></a>        <span class="c1">#åˆå§‹åŒ–å‡½æ•°çš„å‚æ•°æœ‰5ä¸ªï¼Œåˆ†åˆ«æ˜¯sizeï¼Œä»£è¡¨è¯åµŒå…¥çš„ç»´åº¦å¤§å°ï¼ŒåŒæ—¶ä¹Ÿä»£è¡¨è§£ç å™¨çš„å°ºå¯¸ï¼Œç¬¬äºŒä¸ªæ˜¯self_attnï¼Œå¤šå¤´è‡ªæ³¨æ„åŠ›å¯¹è±¡ï¼Œä¹Ÿå°±æ˜¯è¯´è¿™ä¸ªæ³¨æ„åŠ›æœºåˆ¶éœ€è¦Q=K=Vï¼Œç¬¬ä¸‰ä¸ªæ˜¯src_attn,å¤šå¤´æ³¨æ„åŠ›å¯¹è±¡ï¼Œè¿™é‡ŒQ!=K=Vï¼Œç¬¬å››ä¸ªæ˜¯å‰é¦ˆå…¨è¿æ¥å±‚å¯¹è±¡ï¼Œæœ€åå°±æ˜¯dropoutç½®0æ¯”ç‡</span>
</span><span id="__span-12-6"><a id="__codelineno-12-6" name="__codelineno-12-6" href="#__codelineno-12-6"></a>        <span class="nb">super</span><span class="p">(</span><span class="n">DecoderLayer</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="__span-12-7"><a id="__codelineno-12-7" name="__codelineno-12-7" href="#__codelineno-12-7"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">size</span>
</span><span id="__span-12-8"><a id="__codelineno-12-8" name="__codelineno-12-8" href="#__codelineno-12-8"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">self_attn</span> <span class="o">=</span> <span class="n">self_attn</span>
</span><span id="__span-12-9"><a id="__codelineno-12-9" name="__codelineno-12-9" href="#__codelineno-12-9"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">src_attn</span> <span class="o">=</span> <span class="n">src_attn</span>
</span><span id="__span-12-10"><a id="__codelineno-12-10" name="__codelineno-12-10" href="#__codelineno-12-10"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">feed_forward</span> <span class="o">=</span> <span class="n">feed_forward</span>
</span><span id="__span-12-11"><a id="__codelineno-12-11" name="__codelineno-12-11" href="#__codelineno-12-11"></a>        <span class="c1">#æŒ‰ç…§ç»“æ„å›¾ä½¿ç”¨cloneså‡½æ•°å…‹éš†ä¸‰ä¸ªå­å±‚è¿æ¥å¯¹è±¡</span>
</span><span id="__span-12-12"><a id="__codelineno-12-12" name="__codelineno-12-12" href="#__codelineno-12-12"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sublayer</span> <span class="o">=</span> <span class="n">clones</span><span class="p">(</span><span class="n">SublayerConnection</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">dropout</span><span class="p">),</span> <span class="mi">3</span><span class="p">)</span>
</span><span id="__span-12-13"><a id="__codelineno-12-13" name="__codelineno-12-13" href="#__codelineno-12-13"></a>
</span><span id="__span-12-14"><a id="__codelineno-12-14" name="__codelineno-12-14" href="#__codelineno-12-14"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">memory</span><span class="p">,</span> <span class="n">src_mask</span><span class="p">,</span> <span class="n">tgt_mask</span><span class="p">):</span>
</span><span id="__span-12-15"><a id="__codelineno-12-15" name="__codelineno-12-15" href="#__codelineno-12-15"></a>        <span class="c1">#forwardå‡½æ•°ä¸­çš„å‚æ•°æœ‰4ä¸ªï¼Œåˆ†åˆ«æ˜¯æ¥è‡ªä¸Šä¸€å±‚çš„è¾“å…¥xï¼Œæ¥è‡ªç¼–ç å™¨å±‚çš„è¯­ä¹‰å­˜å‚¨å˜é‡memoryï¼Œä»¥åŠæºæ•°æ®æ©ç å¼ é‡å’Œç›®æ ‡æ•°æ®æ©ç å¼ é‡ï¼Œå°†memoryè¡¨ç¤ºæˆmä¹‹åæ–¹ä¾¿ä½¿ç”¨ã€‚</span>
</span><span id="__span-12-16"><a id="__codelineno-12-16" name="__codelineno-12-16" href="#__codelineno-12-16"></a>        <span class="s2">&quot;Follow Figure 1 (right) for connections.&quot;</span>
</span><span id="__span-12-17"><a id="__codelineno-12-17" name="__codelineno-12-17" href="#__codelineno-12-17"></a>        <span class="n">m</span> <span class="o">=</span> <span class="n">memory</span>
</span><span id="__span-12-18"><a id="__codelineno-12-18" name="__codelineno-12-18" href="#__codelineno-12-18"></a>        <span class="c1">#å°†xä¼ å…¥ç¬¬ä¸€ä¸ªå­å±‚ç»“æ„ï¼Œç¬¬ä¸€ä¸ªå­å±‚ç»“æ„çš„è¾“å…¥åˆ†åˆ«æ˜¯xå’Œself-attnå‡½æ•°ï¼Œå› ä¸ºæ˜¯è‡ªæ³¨æ„åŠ›æœºåˆ¶ï¼Œæ‰€ä»¥Q,K,Véƒ½æ˜¯xï¼Œæœ€åä¸€ä¸ªå‚æ•°æ—¶ç›®æ ‡æ•°æ®æ©ç å¼ é‡ï¼Œè¿™æ—¶è¦å¯¹ç›®æ ‡æ•°æ®è¿›è¡Œé®æ©ï¼Œå› ä¸ºæ­¤æ—¶æ¨¡å‹å¯èƒ½è¿˜æ²¡æœ‰ç”Ÿæˆä»»ä½•ç›®æ ‡æ•°æ®ã€‚</span>
</span><span id="__span-12-19"><a id="__codelineno-12-19" name="__codelineno-12-19" href="#__codelineno-12-19"></a>        <span class="c1">#æ¯”å¦‚åœ¨è§£ç å™¨å‡†å¤‡ç”Ÿæˆç¬¬ä¸€ä¸ªå­—ç¬¦æˆ–è¯æ±‡æ—¶ï¼Œæˆ‘ä»¬å…¶å®å·²ç»ä¼ å…¥äº†ç¬¬ä¸€ä¸ªå­—ç¬¦ä»¥ä¾¿è®¡ç®—æŸå¤±ï¼Œä½†æ˜¯æˆ‘ä»¬ä¸å¸Œæœ›åœ¨ç”Ÿæˆç¬¬ä¸€ä¸ªå­—ç¬¦æ—¶æ¨¡å‹èƒ½åˆ©ç”¨è¿™ä¸ªä¿¡æ¯ï¼Œå› æ­¤æˆ‘ä»¬ä¼šå°†å…¶é®æ©ï¼ŒåŒæ ·ç”Ÿæˆç¬¬äºŒä¸ªå­—ç¬¦æˆ–è¯æ±‡æ—¶ï¼Œæ¨¡å‹åªèƒ½ä½¿ç”¨ç¬¬ä¸€ä¸ªå­—ç¬¦æˆ–è¯æ±‡ä¿¡æ¯ï¼Œç¬¬äºŒä¸ªå­—ç¬¦ä»¥åŠä¹‹åçš„ä¿¡æ¯éƒ½ä¸å…è®¸è¢«æ¨¡å‹ä½¿ç”¨ã€‚</span>
</span><span id="__span-12-20"><a id="__codelineno-12-20" name="__codelineno-12-20" href="#__codelineno-12-20"></a>        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sublayer</span><span class="p">[</span><span class="mi">0</span><span class="p">](</span><span class="n">x</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">self_attn</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">tgt_mask</span><span class="p">))</span>
</span><span id="__span-12-21"><a id="__codelineno-12-21" name="__codelineno-12-21" href="#__codelineno-12-21"></a>        <span class="c1">#æ¥ç€è¿›å…¥ç¬¬äºŒä¸ªå­å±‚ï¼Œè¿™ä¸ªå­å±‚ä¸­å¸¸è§„çš„æ³¨æ„åŠ›æœºåˆ¶ï¼Œqæ˜¯è¾“å…¥x;k,væ˜¯ç¼–ç å±‚è¾“å‡ºmemoryï¼ŒåŒæ ·ä¹Ÿä¼ å…¥source_maskï¼Œä½†æ˜¯è¿›è¡Œæºæ•°æ®é®æ©çš„åŸå› å¹¶éæ˜¯æŠ‘åˆ¶ä¿¡æ¯æ³„éœ²ï¼Œè€Œæ˜¯é®è”½æ‰å¯¹ç»“æœæ²¡æœ‰æ„ä¹‰çš„paddingã€‚</span>
</span><span id="__span-12-22"><a id="__codelineno-12-22" name="__codelineno-12-22" href="#__codelineno-12-22"></a>        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sublayer</span><span class="p">[</span><span class="mi">1</span><span class="p">](</span><span class="n">x</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">src_attn</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">src_mask</span><span class="p">))</span>
</span><span id="__span-12-23"><a id="__codelineno-12-23" name="__codelineno-12-23" href="#__codelineno-12-23"></a>
</span><span id="__span-12-24"><a id="__codelineno-12-24" name="__codelineno-12-24" href="#__codelineno-12-24"></a>        <span class="c1">#æœ€åä¸€ä¸ªå­å±‚å°±æ˜¯å‰é¦ˆå…¨è¿æ¥å­å±‚ï¼Œç»è¿‡å®ƒçš„å¤„ç†åå°±å¯ä»¥è¿”å›ç»“æœï¼Œè¿™å°±æ˜¯æˆ‘ä»¬çš„è§£ç å™¨ç»“æ„</span>
</span><span id="__span-12-25"><a id="__codelineno-12-25" name="__codelineno-12-25" href="#__codelineno-12-25"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sublayer</span><span class="p">[</span><span class="mi">2</span><span class="p">](</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">feed_forward</span><span class="p">)</span>
</span></code></pre></div>
<h3 id="_3">å››ã€æ¨¡å‹è¾“å‡º<a class="headerlink" href="#_3" title="Permanent link">&para;</a></h3>
<p>è¾“å‡ºéƒ¨åˆ†å°±å¾ˆç®€å•äº†ï¼Œæ¯ä¸ªæ—¶é—´æ­¥éƒ½è¿‡ä¸€ä¸ª çº¿æ€§å±‚ + softmaxå±‚</p>
<p><img alt="output.jpg" src="../../../imgs/llm/chapter00/output.jpg" /></p>
<p>çº¿æ€§å±‚çš„ä½œç”¨ï¼šé€šè¿‡å¯¹ä¸Šä¸€æ­¥çš„çº¿æ€§å˜åŒ–å¾—åˆ°æŒ‡å®šç»´åº¦çš„è¾“å‡ºï¼Œä¹Ÿå°±æ˜¯è½¬æ¢ç»´åº¦çš„ä½œç”¨ã€‚è½¬æ¢åçš„ç»´åº¦å¯¹åº”ç€è¾“å‡ºç±»åˆ«çš„ä¸ªæ•°ï¼Œå¦‚æœæ˜¯ç¿»è¯‘ä»»åŠ¡ï¼Œé‚£å°±å¯¹åº”çš„æ˜¯æ–‡å­—å­—å…¸çš„å¤§å°ã€‚</p>
<p>ä»£ç å¦‚ä¸‹ï¼š</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-13-1"><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a><span class="c1">#å°†çº¿æ€§å±‚å’Œsoftmaxè®¡ç®—å±‚ä¸€èµ·å®ç°ï¼Œå› ä¸ºäºŒè€…çš„å…±åŒç›®æ ‡æ˜¯ç”Ÿæˆæœ€åçš„ç»“æ„</span>
</span><span id="__span-13-2"><a id="__codelineno-13-2" name="__codelineno-13-2" href="#__codelineno-13-2"></a><span class="c1">#å› æ­¤æŠŠç±»çš„åå­—å«åšGeneratorï¼Œç”Ÿæˆå™¨ç±»</span>
</span><span id="__span-13-3"><a id="__codelineno-13-3" name="__codelineno-13-3" href="#__codelineno-13-3"></a><span class="k">class</span><span class="w"> </span><span class="nc">Generator</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
</span><span id="__span-13-4"><a id="__codelineno-13-4" name="__codelineno-13-4" href="#__codelineno-13-4"></a>    <span class="s2">&quot;Define standard linear + softmax generation step.&quot;</span>
</span><span id="__span-13-5"><a id="__codelineno-13-5" name="__codelineno-13-5" href="#__codelineno-13-5"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">d_model</span><span class="p">,</span> <span class="n">vocab</span><span class="p">):</span>
</span><span id="__span-13-6"><a id="__codelineno-13-6" name="__codelineno-13-6" href="#__codelineno-13-6"></a>        <span class="c1">#åˆå§‹åŒ–å‡½æ•°çš„è¾“å…¥å‚æ•°æœ‰ä¸¤ä¸ªï¼Œd_modelä»£è¡¨è¯åµŒå…¥ç»´åº¦ï¼Œvocab.sizeä»£è¡¨è¯è¡¨å¤§å°</span>
</span><span id="__span-13-7"><a id="__codelineno-13-7" name="__codelineno-13-7" href="#__codelineno-13-7"></a>        <span class="nb">super</span><span class="p">(</span><span class="n">Generator</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="__span-13-8"><a id="__codelineno-13-8" name="__codelineno-13-8" href="#__codelineno-13-8"></a>        <span class="c1">#é¦–å…ˆå°±æ˜¯ä½¿ç”¨nnä¸­çš„é¢„å®šä¹‰çº¿æ€§å±‚è¿›è¡Œå®ä¾‹åŒ–ï¼Œå¾—åˆ°ä¸€ä¸ªå¯¹è±¡self.projç­‰å¾…ä½¿ç”¨</span>
</span><span id="__span-13-9"><a id="__codelineno-13-9" name="__codelineno-13-9" href="#__codelineno-13-9"></a>        <span class="c1">#è¿™ä¸ªçº¿æ€§å±‚çš„å‚æ•°æœ‰ä¸¤ä¸ªï¼Œå°±æ˜¯åˆå§‹åŒ–å‡½æ•°ä¼ è¿›æ¥çš„ä¸¤ä¸ªå‚æ•°ï¼šd_modelï¼Œvocab_size</span>
</span><span id="__span-13-10"><a id="__codelineno-13-10" name="__codelineno-13-10" href="#__codelineno-13-10"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">proj</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">d_model</span><span class="p">,</span> <span class="n">vocab</span><span class="p">)</span>
</span><span id="__span-13-11"><a id="__codelineno-13-11" name="__codelineno-13-11" href="#__codelineno-13-11"></a>
</span><span id="__span-13-12"><a id="__codelineno-13-12" name="__codelineno-13-12" href="#__codelineno-13-12"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
</span><span id="__span-13-13"><a id="__codelineno-13-13" name="__codelineno-13-13" href="#__codelineno-13-13"></a>        <span class="c1">#å‰å‘é€»è¾‘å‡½æ•°ä¸­è¾“å…¥æ˜¯ä¸Šä¸€å±‚çš„è¾“å‡ºå¼ é‡x,åœ¨å‡½æ•°ä¸­ï¼Œé¦–å…ˆä½¿ç”¨ä¸Šä¸€æ­¥å¾—åˆ°çš„self.projå¯¹xè¿›è¡Œçº¿æ€§å˜åŒ–,ç„¶åä½¿ç”¨Fä¸­å·²ç»å®ç°çš„log_softmaxè¿›è¡Œsoftmaxå¤„ç†ã€‚</span>
</span><span id="__span-13-14"><a id="__codelineno-13-14" name="__codelineno-13-14" href="#__codelineno-13-14"></a>        <span class="k">return</span> <span class="n">F</span><span class="o">.</span><span class="n">log_softmax</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">proj</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
</span></code></pre></div>
<h3 id="_4">äº”ã€æ¨¡å‹æ„å»º<a class="headerlink" href="#_4" title="Permanent link">&para;</a></h3>
<p>ä¸‹é¢æ˜¯Transformeræ€»ä½“æ¶æ„å›¾ï¼Œå›é¡¾ä¸€ä¸‹ï¼Œå†çœ‹è¿™å¼ å›¾ï¼Œæ˜¯ä¸æ˜¯æ¯ä¸ªæ¨¡å—çš„ä½œç”¨éƒ½æœ‰äº†åŸºæœ¬çš„è®¤çŸ¥ã€‚</p>
<p><img alt="transformer.jpg" src="../../../imgs/llm/chapter00/transformer.jpg" /></p>
<p>ä¸‹é¢æˆ‘ä»¬å°±å¯ä»¥æ­å»ºå‡ºæ•´ä¸ªç½‘ç»œçš„ç»“æ„</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-14-1"><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a><span class="c1"># Model Architecture</span>
</span><span id="__span-14-2"><a id="__codelineno-14-2" name="__codelineno-14-2" href="#__codelineno-14-2"></a><span class="c1">#ä½¿ç”¨EncoderDecoderç±»æ¥å®ç°ç¼–ç å™¨-è§£ç å™¨ç»“æ„</span>
</span><span id="__span-14-3"><a id="__codelineno-14-3" name="__codelineno-14-3" href="#__codelineno-14-3"></a><span class="k">class</span><span class="w"> </span><span class="nc">EncoderDecoder</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
</span><span id="__span-14-4"><a id="__codelineno-14-4" name="__codelineno-14-4" href="#__codelineno-14-4"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="__span-14-5"><a id="__codelineno-14-5" name="__codelineno-14-5" href="#__codelineno-14-5"></a><span class="sd">    A standard Encoder-Decoder architecture. </span>
</span><span id="__span-14-6"><a id="__codelineno-14-6" name="__codelineno-14-6" href="#__codelineno-14-6"></a><span class="sd">    Base for this and many other models.</span>
</span><span id="__span-14-7"><a id="__codelineno-14-7" name="__codelineno-14-7" href="#__codelineno-14-7"></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="__span-14-8"><a id="__codelineno-14-8" name="__codelineno-14-8" href="#__codelineno-14-8"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">encoder</span><span class="p">,</span> <span class="n">decoder</span><span class="p">,</span> <span class="n">src_embed</span><span class="p">,</span> <span class="n">tgt_embed</span><span class="p">,</span> <span class="n">generator</span><span class="p">):</span>
</span><span id="__span-14-9"><a id="__codelineno-14-9" name="__codelineno-14-9" href="#__codelineno-14-9"></a>        <span class="c1">#åˆå§‹åŒ–å‡½æ•°ä¸­æœ‰5ä¸ªå‚æ•°ï¼Œåˆ†åˆ«æ˜¯ç¼–ç å™¨å¯¹è±¡ï¼Œè§£ç å™¨å¯¹è±¡,æºæ•°æ®åµŒå…¥å‡½æ•°ï¼Œç›®æ ‡æ•°æ®åµŒå…¥å‡½æ•°ï¼Œä»¥åŠè¾“å‡ºéƒ¨åˆ†çš„ç±»åˆ«ç”Ÿæˆå™¨å¯¹è±¡.</span>
</span><span id="__span-14-10"><a id="__codelineno-14-10" name="__codelineno-14-10" href="#__codelineno-14-10"></a>        <span class="nb">super</span><span class="p">(</span><span class="n">EncoderDecoder</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="__span-14-11"><a id="__codelineno-14-11" name="__codelineno-14-11" href="#__codelineno-14-11"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">encoder</span> <span class="o">=</span> <span class="n">encoder</span>
</span><span id="__span-14-12"><a id="__codelineno-14-12" name="__codelineno-14-12" href="#__codelineno-14-12"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">decoder</span> <span class="o">=</span> <span class="n">decoder</span>
</span><span id="__span-14-13"><a id="__codelineno-14-13" name="__codelineno-14-13" href="#__codelineno-14-13"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">src_embed</span> <span class="o">=</span> <span class="n">src_embed</span>    <span class="c1"># input embedding module(input embedding + positional encode)</span>
</span><span id="__span-14-14"><a id="__codelineno-14-14" name="__codelineno-14-14" href="#__codelineno-14-14"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">tgt_embed</span> <span class="o">=</span> <span class="n">tgt_embed</span>    <span class="c1"># ouput embedding module</span>
</span><span id="__span-14-15"><a id="__codelineno-14-15" name="__codelineno-14-15" href="#__codelineno-14-15"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">generator</span> <span class="o">=</span> <span class="n">generator</span>    <span class="c1"># output generation module</span>
</span><span id="__span-14-16"><a id="__codelineno-14-16" name="__codelineno-14-16" href="#__codelineno-14-16"></a>
</span><span id="__span-14-17"><a id="__codelineno-14-17" name="__codelineno-14-17" href="#__codelineno-14-17"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">tgt</span><span class="p">,</span> <span class="n">src_mask</span><span class="p">,</span> <span class="n">tgt_mask</span><span class="p">):</span>
</span><span id="__span-14-18"><a id="__codelineno-14-18" name="__codelineno-14-18" href="#__codelineno-14-18"></a>        <span class="s2">&quot;Take in and process masked src and target sequences.&quot;</span>
</span><span id="__span-14-19"><a id="__codelineno-14-19" name="__codelineno-14-19" href="#__codelineno-14-19"></a>        <span class="c1">#åœ¨forwardå‡½æ•°ä¸­ï¼Œæœ‰å››ä¸ªå‚æ•°ï¼Œsourceä»£è¡¨æºæ•°æ®ï¼Œtargetä»£è¡¨ç›®æ ‡æ•°æ®,source_maskå’Œtarget_maskä»£è¡¨å¯¹åº”çš„æ©ç å¼ é‡,åœ¨å‡½æ•°ä¸­ï¼Œå°†source source_maskä¼ å…¥ç¼–ç å‡½æ•°ï¼Œå¾—åˆ°ç»“æœåä¸source_mask target å’Œtarget_maskä¸€åŒä¼ ç»™è§£ç å‡½æ•°</span>
</span><span id="__span-14-20"><a id="__codelineno-14-20" name="__codelineno-14-20" href="#__codelineno-14-20"></a>        <span class="n">memory</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">src_mask</span><span class="p">)</span>
</span><span id="__span-14-21"><a id="__codelineno-14-21" name="__codelineno-14-21" href="#__codelineno-14-21"></a>        <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">memory</span><span class="p">,</span> <span class="n">src_mask</span><span class="p">,</span> <span class="n">tgt</span><span class="p">,</span> <span class="n">tgt_mask</span><span class="p">)</span>
</span><span id="__span-14-22"><a id="__codelineno-14-22" name="__codelineno-14-22" href="#__codelineno-14-22"></a>        <span class="k">return</span> <span class="n">res</span>
</span><span id="__span-14-23"><a id="__codelineno-14-23" name="__codelineno-14-23" href="#__codelineno-14-23"></a>
</span><span id="__span-14-24"><a id="__codelineno-14-24" name="__codelineno-14-24" href="#__codelineno-14-24"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">encode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">src_mask</span><span class="p">):</span>
</span><span id="__span-14-25"><a id="__codelineno-14-25" name="__codelineno-14-25" href="#__codelineno-14-25"></a>        <span class="c1">#ç¼–ç å‡½æ•°ï¼Œä»¥sourceå’Œsource_maskä¸ºå‚æ•°,ä½¿ç”¨src_embedå¯¹sourceåšå¤„ç†ï¼Œç„¶åå’Œsource_maskä¸€èµ·ä¼ ç»™self.encoder</span>
</span><span id="__span-14-26"><a id="__codelineno-14-26" name="__codelineno-14-26" href="#__codelineno-14-26"></a>        <span class="n">src_embedds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">src_embed</span><span class="p">(</span><span class="n">src</span><span class="p">)</span>
</span><span id="__span-14-27"><a id="__codelineno-14-27" name="__codelineno-14-27" href="#__codelineno-14-27"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoder</span><span class="p">(</span><span class="n">src_embedds</span><span class="p">,</span> <span class="n">src_mask</span><span class="p">)</span>
</span><span id="__span-14-28"><a id="__codelineno-14-28" name="__codelineno-14-28" href="#__codelineno-14-28"></a>
</span><span id="__span-14-29"><a id="__codelineno-14-29" name="__codelineno-14-29" href="#__codelineno-14-29"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">decode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">memory</span><span class="p">,</span> <span class="n">src_mask</span><span class="p">,</span> <span class="n">tgt</span><span class="p">,</span> <span class="n">tgt_mask</span><span class="p">):</span>
</span><span id="__span-14-30"><a id="__codelineno-14-30" name="__codelineno-14-30" href="#__codelineno-14-30"></a>        <span class="c1">#è§£ç å‡½æ•°ï¼Œä»¥memoryå³ç¼–ç å™¨çš„è¾“å‡ºï¼Œsource_mask target target_maskä¸ºå‚æ•°,ä½¿ç”¨tgt_embedå¯¹targetåšå¤„ç†ï¼Œç„¶åå’Œsource_mask,target_mask,memoryä¸€èµ·ä¼ ç»™self.decoder</span>
</span><span id="__span-14-31"><a id="__codelineno-14-31" name="__codelineno-14-31" href="#__codelineno-14-31"></a>        <span class="n">target_embedds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tgt_embed</span><span class="p">(</span><span class="n">tgt</span><span class="p">)</span>
</span><span id="__span-14-32"><a id="__codelineno-14-32" name="__codelineno-14-32" href="#__codelineno-14-32"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">decoder</span><span class="p">(</span><span class="n">target_embedds</span><span class="p">,</span> <span class="n">memory</span><span class="p">,</span> <span class="n">src_mask</span><span class="p">,</span> <span class="n">tgt_mask</span><span class="p">)</span>
</span><span id="__span-14-33"><a id="__codelineno-14-33" name="__codelineno-14-33" href="#__codelineno-14-33"></a>
</span><span id="__span-14-34"><a id="__codelineno-14-34" name="__codelineno-14-34" href="#__codelineno-14-34"></a>
</span><span id="__span-14-35"><a id="__codelineno-14-35" name="__codelineno-14-35" href="#__codelineno-14-35"></a><span class="c1"># Full Model</span>
</span><span id="__span-14-36"><a id="__codelineno-14-36" name="__codelineno-14-36" href="#__codelineno-14-36"></a><span class="k">def</span><span class="w"> </span><span class="nf">make_model</span><span class="p">(</span><span class="n">src_vocab</span><span class="p">,</span> <span class="n">tgt_vocab</span><span class="p">,</span> <span class="n">N</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">d_model</span><span class="o">=</span><span class="mi">512</span><span class="p">,</span> <span class="n">d_ff</span><span class="o">=</span><span class="mi">2048</span><span class="p">,</span> <span class="n">h</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">dropout</span><span class="o">=</span><span class="mf">0.1</span><span class="p">):</span>
</span><span id="__span-14-37"><a id="__codelineno-14-37" name="__codelineno-14-37" href="#__codelineno-14-37"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="__span-14-38"><a id="__codelineno-14-38" name="__codelineno-14-38" href="#__codelineno-14-38"></a><span class="sd">    æ„å»ºæ¨¡å‹</span>
</span><span id="__span-14-39"><a id="__codelineno-14-39" name="__codelineno-14-39" href="#__codelineno-14-39"></a><span class="sd">    params:</span>
</span><span id="__span-14-40"><a id="__codelineno-14-40" name="__codelineno-14-40" href="#__codelineno-14-40"></a><span class="sd">        src_vocab:</span>
</span><span id="__span-14-41"><a id="__codelineno-14-41" name="__codelineno-14-41" href="#__codelineno-14-41"></a><span class="sd">        tgt_vocab:</span>
</span><span id="__span-14-42"><a id="__codelineno-14-42" name="__codelineno-14-42" href="#__codelineno-14-42"></a><span class="sd">        N: ç¼–ç å™¨å’Œè§£ç å™¨å †å åŸºç¡€æ¨¡å—çš„ä¸ªæ•°</span>
</span><span id="__span-14-43"><a id="__codelineno-14-43" name="__codelineno-14-43" href="#__codelineno-14-43"></a><span class="sd">        d_model: æ¨¡å‹ä¸­embeddingçš„sizeï¼Œé»˜è®¤512</span>
</span><span id="__span-14-44"><a id="__codelineno-14-44" name="__codelineno-14-44" href="#__codelineno-14-44"></a><span class="sd">        d_ff: FeedForward Layerå±‚ä¸­embeddingçš„sizeï¼Œé»˜è®¤2048</span>
</span><span id="__span-14-45"><a id="__codelineno-14-45" name="__codelineno-14-45" href="#__codelineno-14-45"></a><span class="sd">        h: MultiHeadAttentionä¸­å¤šå¤´çš„ä¸ªæ•°ï¼Œå¿…é¡»è¢«d_modelæ•´é™¤</span>
</span><span id="__span-14-46"><a id="__codelineno-14-46" name="__codelineno-14-46" href="#__codelineno-14-46"></a><span class="sd">        dropout:</span>
</span><span id="__span-14-47"><a id="__codelineno-14-47" name="__codelineno-14-47" href="#__codelineno-14-47"></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="__span-14-48"><a id="__codelineno-14-48" name="__codelineno-14-48" href="#__codelineno-14-48"></a>    <span class="n">c</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span>
</span><span id="__span-14-49"><a id="__codelineno-14-49" name="__codelineno-14-49" href="#__codelineno-14-49"></a>    <span class="n">attn</span> <span class="o">=</span> <span class="n">MultiHeadedAttention</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">d_model</span><span class="p">)</span>
</span><span id="__span-14-50"><a id="__codelineno-14-50" name="__codelineno-14-50" href="#__codelineno-14-50"></a>    <span class="n">ff</span> <span class="o">=</span> <span class="n">PositionwiseFeedForward</span><span class="p">(</span><span class="n">d_model</span><span class="p">,</span> <span class="n">d_ff</span><span class="p">,</span> <span class="n">dropout</span><span class="p">)</span>
</span><span id="__span-14-51"><a id="__codelineno-14-51" name="__codelineno-14-51" href="#__codelineno-14-51"></a>    <span class="n">position</span> <span class="o">=</span> <span class="n">PositionalEncoding</span><span class="p">(</span><span class="n">d_model</span><span class="p">,</span> <span class="n">dropout</span><span class="p">)</span>
</span><span id="__span-14-52"><a id="__codelineno-14-52" name="__codelineno-14-52" href="#__codelineno-14-52"></a>    <span class="n">model</span> <span class="o">=</span> <span class="n">EncoderDecoder</span><span class="p">(</span>
</span><span id="__span-14-53"><a id="__codelineno-14-53" name="__codelineno-14-53" href="#__codelineno-14-53"></a>        <span class="n">Encoder</span><span class="p">(</span><span class="n">EncoderLayer</span><span class="p">(</span><span class="n">d_model</span><span class="p">,</span> <span class="n">c</span><span class="p">(</span><span class="n">attn</span><span class="p">),</span> <span class="n">c</span><span class="p">(</span><span class="n">ff</span><span class="p">),</span> <span class="n">dropout</span><span class="p">),</span> <span class="n">N</span><span class="p">),</span>
</span><span id="__span-14-54"><a id="__codelineno-14-54" name="__codelineno-14-54" href="#__codelineno-14-54"></a>        <span class="n">Decoder</span><span class="p">(</span><span class="n">DecoderLayer</span><span class="p">(</span><span class="n">d_model</span><span class="p">,</span> <span class="n">c</span><span class="p">(</span><span class="n">attn</span><span class="p">),</span> <span class="n">c</span><span class="p">(</span><span class="n">attn</span><span class="p">),</span> <span class="n">c</span><span class="p">(</span><span class="n">ff</span><span class="p">),</span> <span class="n">dropout</span><span class="p">),</span> <span class="n">N</span><span class="p">),</span>
</span><span id="__span-14-55"><a id="__codelineno-14-55" name="__codelineno-14-55" href="#__codelineno-14-55"></a>        <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span><span class="n">Embeddings</span><span class="p">(</span><span class="n">d_model</span><span class="p">,</span> <span class="n">src_vocab</span><span class="p">),</span> <span class="n">c</span><span class="p">(</span><span class="n">position</span><span class="p">)),</span>
</span><span id="__span-14-56"><a id="__codelineno-14-56" name="__codelineno-14-56" href="#__codelineno-14-56"></a>        <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span><span class="n">Embeddings</span><span class="p">(</span><span class="n">d_model</span><span class="p">,</span> <span class="n">tgt_vocab</span><span class="p">),</span> <span class="n">c</span><span class="p">(</span><span class="n">position</span><span class="p">)),</span>
</span><span id="__span-14-57"><a id="__codelineno-14-57" name="__codelineno-14-57" href="#__codelineno-14-57"></a>        <span class="n">Generator</span><span class="p">(</span><span class="n">d_model</span><span class="p">,</span> <span class="n">tgt_vocab</span><span class="p">))</span>
</span><span id="__span-14-58"><a id="__codelineno-14-58" name="__codelineno-14-58" href="#__codelineno-14-58"></a>
</span><span id="__span-14-59"><a id="__codelineno-14-59" name="__codelineno-14-59" href="#__codelineno-14-59"></a>    <span class="c1"># This was important from their code. </span>
</span><span id="__span-14-60"><a id="__codelineno-14-60" name="__codelineno-14-60" href="#__codelineno-14-60"></a>    <span class="c1"># Initialize parameters with Glorot / fan_avg.</span>
</span><span id="__span-14-61"><a id="__codelineno-14-61" name="__codelineno-14-61" href="#__codelineno-14-61"></a>    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">():</span>
</span><span id="__span-14-62"><a id="__codelineno-14-62" name="__codelineno-14-62" href="#__codelineno-14-62"></a>        <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">dim</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="__span-14-63"><a id="__codelineno-14-63" name="__codelineno-14-63" href="#__codelineno-14-63"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">xavier_uniform_</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
</span><span id="__span-14-64"><a id="__codelineno-14-64" name="__codelineno-14-64" href="#__codelineno-14-64"></a>    <span class="k">return</span> <span class="n">model</span>
</span></code></pre></div>












                
              </article>
            </div>
          
          
  <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>

<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  å›åˆ°é¡µé¢é¡¶éƒ¨
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
      <div class="md-progress" data-md-component="progress" role="progressbar"></div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../../..", "features": ["content.tabs.link", "navigation.instant", "navigation.instant.progress", "navigation.tabs", "navigation.tabs.sticky", "navigation.prune", "navigation.indexes", "toc.follow", "navigation.top", "search.suggest", "navigation.path", "content.code.copy"], "search": "../../../assets/javascripts/workers/search.d50fe291.min.js", "tags": null, "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}, "version": null}</script>
    
    
      <script src="../../../assets/javascripts/bundle.13a4f30d.min.js"></script>
      
        <script src="../../../styles/js/tablesort.min.js"></script>
      
        <script src="../../../styles/js/tex-mml-chtml.js"></script>
      
    
  </body>
</html>